<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Rapor UPT SDN 22 Tanah Keras</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome untuk ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- SheetJS (XLSX) CDN for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- NEW: HTML2PDF CDN for PDF Download functionality (Still needed for the download function, but the button is removed) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-Z59GUFMgASGz4c4/L3Wd6z2k/iKj9x4x0W1E6xJ9S4W8i/O1m3KjXkP5bC5TzT8V2xWvD+q1j+F9q8z+H9zP8A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .sidebar {
            width: 280px;
            /* Default color: Admin/Blue */
            background-color: #1a73e8; 
            color: white;
            transition: background-color 0.3s ease, width 0.3s ease;
        }
        
        /* --- KELAS COLORS --- */
        /* Hijau - Kelas 1 */
        .color-green-bg { background-color: #10B981 !important; } /* Tailwind emerald-500 */
        .color-green-hover:hover { background-color: #059669 !important; } /* Tailwind emerald-600 */
        .color-green-active { background-color: #047857 !important; } /* Tailwind emerald-700 */
        .color-green-border { border-color: #065F46 !important; }
        .color-green-text { color: #047857 !important; }
        .color-green-light { background-color: #ECFDF5 !important; } /* emerald-50 */

        /* Kuning - Kelas 2 */
        .color-yellow-bg { background-color: #FBBF24 !important; } /* Tailwind amber-400 */
        .color-yellow-hover:hover { background-color: #F59E0B !important; } /* Tailwind amber-500 */
        .color-yellow-active { background-color: #D97706 !important; } /* Tailwind amber-600 */
        .color-yellow-border { border-color: #B45309 !important; }
        .color-yellow-text { color: #B45309 !important; }
        .color-yellow-light { background-color: #FFFBEB !important; } /* amber-50 */
        
        /* Merah - Kelas 3 */
        .color-red-bg { background-color: #EF4444 !important; } /* Tailwind red-500 */
        .color-red-hover:hover { background-color: #DC2626 !important; } /* Tailwind red-600 */
        .color-red-active { background-color: #B91C1C !important; } /* Tailwind red-700 */
        .color-red-border { border-color: #7F1D1D !important; }
        .color-red-text { color: #B91C1C !important; }
        .color-red-light { background-color: #FEF2F2 !important; } /* red-50 */
        
        /* Ungu - Kelas 4 */
        .color-purple-bg { background-color: #8B5CF6 !important; } /* Tailwind violet-500 */
        .color-purple-hover:hover { background-color: #7C3AED !important; } /* Tailwind violet-600 */
        .color-purple-active { background-color: #6D28D9 !important; } /* Tailwind violet-700 */
        .color-purple-border { border-color: #5B21B6 !important; }
        .color-purple-text { color: #6D28D9 !important; }
        .color-purple-light { background-color: #F5F3FF !important; } /* violet-50 */

        /* Magenta - Kelas 5 (Using Pink/Fuchsia for visibility) */
        .color-magenta-bg { background-color: #D946EF !important; } /* Tailwind fuchsia-500 */
        .color-magenta-hover:hover { background-color: #C026D3 !important; } /* Tailwind fuchsia-600 */
        .color-magenta-active { background-color: #A21CAF !important; } /* Tailwind fuchsia-700 */
        .color-magenta-border { border-color: #86198F !important; }
        .color-magenta-text { color: #A21CAF !important; }
        .color-magenta-light { background-color: #FAE8FF !important; } /* fuchsia-50 */

        /* Abu-abu - Kelas 6 */
        .color-gray-bg { background-color: #6B7280 !important; } /* Tailwind gray-500 */
        .color-gray-hover:hover { background-color: #4B5563 !important; } /* Tailwind gray-600 */
        .color-gray-active { background-color: #374151 !important; } /* Tailwind gray-700 */
        .color-gray-border { border-color: #1F2937 !important; }
        .color-gray-text { color: #374151 !important; }
        .color-gray-light { background-color: #F9FAFB !important; } /* gray-50 */

        /* Default (Admin) / Blue */
        .color-blue-bg { background-color: #1a73e8 !important; }
        .color-blue-hover:hover { background-color: #155bb5 !important; }
        .color-blue-active { background-color: #0d47a1 !important; }
        .color-blue-border { border-color: #155bb5 !important; }
        .color-blue-text { color: #1a73e8 !important; }
        .color-blue-light { background-color: #e0e7ff !important; }

        /* General styles, adjusted to use dynamic classes */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: fixed;
                bottom: 0;
                z-index: 50;
                flex-direction: row;
                overflow-x: auto;
                white-space: nowrap;
                border-top-left-radius: 1rem;
                border-top-right-radius: 1rem;
            }
            .sidebar-title {
                display: none; /* Hide title on mobile */
            }
            .sidebar nav {
                display: flex;
                flex-direction: row;
                padding: 0;
                flex-wrap: nowrap;
            }
            .sidebar-item {
                padding: 0.75rem 1rem;
                margin: 0.5rem 0.25rem;
                flex-direction: column;
                min-width: 80px;
                text-align: center;
            }
            .sidebar-item i {
                margin-right: 0;
                margin-bottom: 0.25rem;
            }
            .sidebar-item span {
                font-size: 0.75rem;
            }
            .main-content-wrapper {
                margin-bottom: 6rem; /* Add space for fixed mobile sidebar */
            }
            .main-content {
                margin-left: 1rem; /* Adjusted for new header/layout */
                margin-right: 1rem;
                margin-top: 1rem;
                padding: 1rem;
            }
        }
        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-radius: 0.5rem;
            margin: 0.5rem 1rem;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        /* Default item styles - overwritten by color classes in JS */
        .sidebar-item:hover {
            background-color: #155bb5;
            transform: translateX(5px);
        }
        .sidebar-item.active {
            background-color: #0d47a1;
            font-weight: bold;
        }
        .sidebar-item i {
            margin-right: 1rem;
            font-size: 1.25rem;
        }
        @media (max-width: 768px) {
            .sidebar-item:hover {
                transform: none;
            }
        }
        .main-content-wrapper {
            flex-grow: 1;
            padding: 0; /* Removed padding */
            background-color: #f0f2f5;
        }
        .main-content {
            padding: 2rem;
            background-color: #f9fafb;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            /* Use margin to separate content from sticky header and edges */
            margin: 2rem; 
        }
        @media (max-width: 768px) {
            .main-content {
                margin-left: 1rem;
                margin-right: 1rem;
                margin-top: 1rem;
            }
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #333;
            background-color: #fff;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
        }
        .btn-primary {
            background-color: #1a73e8;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            background-color: #155bb5;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-secondary:hover {
            background-color: #4b5563;
            transform: translateY(-2px);
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .btn-danger:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
        }
        .btn-edit {
            background-color: #f59e0b;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s ease, transform 0.1s ease;
            margin-right: 0.5rem;
        }
        .btn-edit:hover {
            background-color: #d97706;
            transform: translateY(-1px);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-radius: 0.75rem;
            overflow: hidden; /* For rounded corners on table */
        }
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.9rem; /* Slightly smaller text for tables */
        }
        th {
            background-color: #e0e7ff; /* Light blue header */
            font-weight: 600;
            color: #333;
        }
        tr:nth-child(even) {
            background-color: #f9fafb;
        }
        tr:hover {
            background-color: #eff6ff;
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 500px;
            text-align: center;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .toast.show {
            opacity: 1;
        }
        
        /* Custom style for login page background: added linear gradient overlay */
        #login-page {
            background-image: linear-gradient(to bottom right, rgba(26, 115, 232, 0.8), rgba(13, 71, 161, 0.7)), url('https://iili.io/Ky2VsYF.th.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* Styles for the identity card print area (Preview/Screen) */
        .identity-card-container {
            width: 100%;
            max-width: 900px; 
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ccc;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            background-color: white;
            display: flex;
            flex-direction: column; 
            min-height: 400px; 
        }
        .identity-card-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            text-align: center;
        }
        .identity-card-header img {
            width: 80px;
            height: 80px;
            margin-right: 15px;
        }
        .identity-card-header h2 {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0;
        }
        .identity-card-header p {
            font-size: 0.9rem;
            margin: 0;
        }
        .identity-card-body {
            /* Changed to vertical flow for preview */
            display: flex;
            flex-direction: column; 
            gap: 15px;
            align-items: start;
            flex-grow: 1; 
        }
        /* Updated layout for Identitas Siswa details and photo wrapper */
        .identity-card-details-wrapper {
            display: flex;
            flex-direction: row; /* Details and photo side by side in preview */
            gap: 20px;
            width: 100%;
        }
        .identity-card-photo-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 30%; /* Narrower for side by side in preview */
            max-width: 150px; 
            margin-bottom: 0; /* Removed margin-bottom */
            order: 2; /* Photo on the right in preview */
        }
        .identity-card-details {
            display: block; 
            width: 70%; /* Wider for details in preview */
            order: 1; /* Details on the left in preview */
        }
        .identity-card-photo {
            width: 120px;
            height: 150px;
            background-color: #e0e0e0;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #666;
            margin: 0 auto 10px auto;
        }
        .identity-card-details p {
            margin-bottom: 5px;
            font-size: 0.95rem;
        }
        /* Adjusted for colon alignment (Preview/Screen) */
        .identity-card-details strong {
            display: inline-block;
            width: 180px; /* Increased fixed width for labels to align colons (more generous) */
            text-align: left; 
            margin-right: 5px; 
        }
        .identity-card-footer {
            display: flex;
            justify-content: flex-end; /* Align to the right */
            align-items: flex-end; 
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px dashed #ccc; 
        }
        .identity-card-signature {
            text-align: center;
            width: 300px; /* Fixed width for signature box */
        }

        /* Print styles for Legal/F4 paper size - Apply only on print */
        @media print {
            /* Changed size to Legal (21.59cm x 33.02cm) which is similar to F4 and longer than A4 */
            @page {
                size: 21.59cm 33.02cm; 
                margin: 1cm; 
            }
            body {
                margin: 0;
                padding: 0;
                background-color: white; 
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .identity-card-container {
                width: 19cm; /* Adjusted width for print */
                max-width: 19cm; 
                margin: 0 auto;
                box-shadow: none; 
                border: 2px solid #000; /* Strong border for print */
                padding: 10px; 
            }
            /* Hide elements not needed for print */
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }
            .sidebar, .main-content-wrapper { /* Hide main app elements */
                display: none !important;
            }
            /* Ensure the print content area is visible */
            #print-area-leger, #print-area-rapor, #print-area-identitas {
                display: block;
                width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border-radius: 0;
            }
            /* START: Updated Identitas Siswa Print Layout (Single Column, Dot Alignment) */
            .identity-card-body {
                display: block; /* Full block layout */
                gap: 0;
            }
            .identity-card-details-wrapper {
                display: block; /* Ensures vertical stacking */
                width: 100%;
                order: 1; /* Details first */
            }
            .identity-card-details {
                columns: 1 !important; /* Single column for details */
                width: 100%;
                order: 1;
                margin-top: 10px;
            }
            .identity-card-details p {
                font-size: 0.9rem; /* Slightly larger text for easier reading */
                line-height: 1.5; /* Good spacing */
            }
            .identity-card-details strong {
                display: inline-block;
                width: 180px; /* WIDER fixed width to align all colons */
                text-align: left;
                margin-right: 5px;
            }
            .identity-card-photo-wrapper {
                width: 100%;
                display: block; /* Occupy full width at the bottom of the body */
                order: 2; /* Photo below the details */
                margin-top: 20px;
                text-align: center;
            }
            .identity-card-photo {
                width: 120px;
                height: 150px;
                margin: 0 auto 5px auto;
            }
            .identity-card-footer {
                justify-content: flex-end; /* Align Kepala Sekolah to the right */
                border-top: none; 
                margin-top: 10px;
                padding-top: 10px;
            }
            .identity-card-signature {
                text-align: right;
                width: 300px;
            }
            .identity-card-signature p {
                font-size: 0.85rem;
                text-align: right;
            }
            .identity-card-signature .font-bold {
                margin-top: 3rem;
                text-decoration: underline;
                text-align: right;
            }
            .identity-card-signature .date-line {
                display: block;
                margin-bottom: 0.5rem;
            }
            /* END: Updated Identitas Siswa Print Layout */
        }
        
        /* Style untuk pemisah Rapor massal */
        .rapor-page-break {
            page-break-before: always;
            border-top: 5px dashed #ccc;
            margin-top: 2rem;
            padding-top: 2rem;
        }
        
        /* Loading overlay for PDF generation */
        #pdf-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 2000;
            font-size: 1.5rem;
        }
    </style>
</head>
<body class="flex min-h-screen">
    
    <!-- PDF Loading Overlay -->
    <div id="pdf-loading-overlay">
        <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
        <p>Sedang membuat PDF, mohon tunggu...</p>
    </div>

    <!-- Login Page -->
    <!-- Changed container to use 'justify-between' to push logo left and form right, centered vertically -->
    <div id="login-page" class="fixed inset-0 flex items-center justify-center z-50">
        <!-- Main Login Container (Desktop Only, takes up most of the screen width) -->
        <div class="hidden md:flex w-full max-w-7xl justify-between items-center px-8">
            <!-- Logo and Title Block (Left Side) -->
            <div class="text-white text-center p-8">
                <!-- Logo (size increased to w-36, h-36) -->
                <img src="https://iili.io/3b1SedN.png" alt="Logo Sekolah" class="w-36 h-36 mx-auto mb-6 drop-shadow-lg">
                <h1 class="text-5xl font-extrabold mb-1 drop-shadow-lg" style="color: #FFEB3B;">E-RAPOR</h1>
                <p class="text-2xl font-semibold drop-shadow-lg">UPT SDN 22 TANAH KERAS</p>
            </div>
            
            <!-- Login Form Card (Right Side, size reduced to max-w-xs) -->
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xs">
                <h2 class="text-xl font-bold text-center text-gray-800 mb-5">Login Aplikasi</h2>
                <form id="login-form">
                    <div class="form-group">
                        <label for="username">Username:</label>
                        <input type="text" id="username" name="username" required class="focus:ring-blue-500 focus:border-blue-500 p-2 text-sm">
                    </div>
                    <div class="form-group">
                        <label for="password">Password:</label>
                        <input type="password" id="password" name="password" required class="focus:ring-blue-500 focus:border-blue-500 p-2 text-sm">
                    </div>
                    <div class="form-group">
                        <label for="role-select">Peran:</label>
                        <select id="role-select" name="role" class="focus:ring-blue-500 focus:border-blue-500 p-2 text-sm">
                            <option value="Admin">Admin</option>
                            <option value="Guru Kelas 1">Guru Kelas 1</option>
                            <option value="Guru Kelas 2">Guru Kelas 2</option>
                            <option value="Guru Kelas 3">Guru Kelas 3</option>
                            <option value="Guru Kelas 4">Guru Kelas 4</option>
                            <option value="Guru Kelas 5">Guru Kelas 5</option>
                            <option value="Guru Kelas 6">Guru Kelas 6</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full btn-primary mt-3 p-2 text-sm">Login</button>
                </form>
                <div id="login-error" class="text-red-500 text-center mt-3 text-sm hidden">Username atau password salah!</div>
            </div>
        </div>
        
        <!-- Mobile/Small Screen Fallback: Centered Login Form -->
        <div class="md:hidden bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm mx-4">
            <div class="text-center mb-6">
                <img src="https://iili.io/3b1SedN.png" alt="Logo Sekolah" class="w-20 h-20 mx-auto mb-2">
                <h2 class="text-xl font-bold text-gray-800">Login Aplikasi</h2>
                <p class="text-xs text-gray-600">E-Rapor UPT SDN 22 TANAH KERAS</p>
            </div>
            <form id="login-form-mobile">
                <div class="form-group">
                    <label for="username-mobile">Username:</label>
                    <input type="text" id="username-mobile" name="username" required class="focus:ring-blue-500 focus:border-blue-500 p-2 text-sm">
                </div>
                <div class="form-group">
                    <label for="password-mobile">Password:</label>
                    <input type="password" id="password-mobile" name="password" required class="focus:ring-blue-500 focus:border-blue-500 p-2 text-sm">
                </div>
                <div class="form-group">
                    <label for="role-select-mobile">Peran:</label>
                    <select id="role-select-mobile" name="role" class="focus:ring-blue-500 focus:border-blue-500 p-2 text-sm">
                        <option value="Admin">Admin</option>
                        <option value="Guru Kelas 1">Guru Kelas 1</option>
                        <option value="Guru Kelas 2">Guru Kelas 2</option>
                        <option value="Guru Kelas 3">Guru Kelas 3</option>
                        <option value="Guru Kelas 4">Guru Kelas 4</option>
                        <option value="Guru Kelas 5">Guru Kelas 5</option>
                        <option value="Guru Kelas 6">Guru Kelas 6</option>
                    </select>
                </div>
                <button type="submit" class="w-full btn-primary mt-3 p-2 text-sm">Login</button>
            </form>
            <div id="login-error-mobile" class="text-red-500 text-center mt-3 text-sm hidden">Username atau password salah!</div>
        </div>
    </div>

    <!-- Main Application Container -->
    <!-- MODIFIKASI: Tambahkan class dinamis ke sidebar dan header -->
    <div id="app-container" class="hidden md:flex flex-1 h-screen">
        <!-- Sidebar Navigation -->
        <aside id="app-sidebar" class="sidebar flex flex-col p-4 shadow-lg fixed md:relative md:flex-shrink-0 h-full color-blue-bg">
            <div class="sidebar-title text-2xl font-bold text-center py-6 border-b border-blue-400 mb-4 color-blue-border">
                <!-- START: MODIFIKASI UNTUK LOGO -->
                <img src="https://iili.io/3b1SedN.png" alt="Logo Sekolah" class="w-20 h-20 mx-auto" onerror="this.onerror=null;this.src='https://placehold.co/80x80/2A76D9/ffffff?text=LOGO'">
                <!-- END: MODIFIKASI UNTUK LOGO -->
            </div>
            <!-- MODIFIKASI: Tambahkan overflow-y-auto untuk mengaktifkan scrollbar pada menu navigasi -->
            <nav class="flex-1 md:flex-col overflow-y-auto">
                <div class="sidebar-item active" data-target="beranda">
                    <i class="fas fa-home"></i>
                    <span>Beranda</span>
                </div>
                <div class="sidebar-item" data-target="data-sekolah">
                    <i class="fas fa-school"></i>
                    <span>Data Sekolah</span>
                </div>
                <div class="sidebar-item" data-target="data-walas">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>Data Wali Kelas</span>
                </div>
                <div class="sidebar-item" data-target="data-siswa">
                    <i class="fas fa-user-graduate"></i>
                    <span>Data Siswa</span>
                </div>
                <!-- New sidebar item for Import Data Siswa -->
                <div class="sidebar-item" data-target="import-data-siswa">
                    <i class="fas fa-file-import"></i>
                    <span>Impor Data Siswa</span>
                </div>
                <div class="sidebar-item" data-target="mata-pelajaran">
                    <i class="fas fa-book"></i>
                    <span>Mata Pelajaran</span>
                </div>
                <div class="sidebar-item" data-target="ekstrakurikuler">
                    <i class="fas fa-running"></i>
                    <span>Ekstrakurikuler</span>
                </div>
                <div class="sidebar-item" data-target="kokurikuler">
                    <i class="fas fa-puzzle-piece"></i>
                    <span>Kokurikuler</span>
                </div>
                <div class="sidebar-item" data-target="tujuan-pembelajaran">
                    <i class="fas fa-bullseye"></i>
                    <span>Tujuan Pembelajaran</span>
                </div>
                <div class="sidebar-item" data-target="input-nilai">
                    <i class="fas fa-edit"></i>
                    <span>Input Nilai</span>
                </div>
                <div class="sidebar-item" data-target="ketidakhadiran">
                    <i class="fas fa-user-times"></i>
                    <span>Ketidakhadiran</span>
                </div>
                <div class="sidebar-item" data-target="catatan-walas">
                    <i class="fas fa-comments"></i>
                    <span>Catatan Wali Kelas</span>
                </div>
                <div class="sidebar-item" data-target="kenaikan-kelas">
                    <i class="fas fa-arrow-up"></i>
                    <span>Kenaikan Kelas</span>
                </div>
                <div class="sidebar-item" data-target="cetak-leger">
                    <i class="fas fa-print"></i>
                    <span>Cetak Leger Nilai</span>
                </div>
                <div class="sidebar-item" data-target="cetak-rapor">
                    <i class="fas fa-file-alt"></i>
                    <span>Cetak Rapor</span>
                </div>
                <div class="sidebar-item" data-target="cetak-identitas-siswa">
                    <i class="fas fa-id-card"></i>
                    <span>Cetak Identitas Siswa</span>
                </div>
                <div class="sidebar-item Admin-only" data-target="manajemen-pengguna">
                    <i class="fas fa-users-cog"></i>
                    <span>Manajemen Pengguna</span>
                </div>
                <div class="sidebar-item Admin-only" data-target="pengaturan">
                    <i class="fas fa-cog"></i>
                    <span>Pengaturan</span>
                </div>
            </nav>
            <div class="mt-auto md:block hidden">
                <div class="sidebar-item" id="backup-data-btn">
                    <i class="fas fa-download"></i>
                    <span>Backup Data</span>
                </div>
                <div class="sidebar-item" id="restore-data-btn">
                    <i class="fas fa-upload"></i>
                    <span>Pulihkan Data</span>
                </div>
                <!-- Tombol Logout DIPINDAHKAN ke Header -->
            </div>
        </aside>

        <!-- Main Content Area -->
        <div class="main-content-wrapper flex-1 overflow-y-auto">
            
            <!-- New Header Bar for Title and Logout Button -->
            <!-- MODIFIKASI: Tambahkan class dinamis ke header -->
            <header id="app-header" class="bg-white shadow-lg sticky top-0 z-40 px-4 py-3 md:px-8 flex justify-between items-center border-b border-gray-200">
                <!-- Title/Info placeholder -->
                <div class="text-xl font-bold text-gray-800 hidden md:block">Dashboard E-Rapor</div> 
                <div class="text-xl font-bold text-gray-800 md:hidden">E-Rapor</div> 
                
                <!-- Logout Button (Positioned to the right) -->
                <button id="logout-btn" class="flex items-center space-x-2 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 text-sm">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </header>

            <main class="main-content flex-1 overflow-y-auto">
                <!-- Beranda Section -->
                <section id="beranda" class="content-section">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Selamat Datang di Aplikasi E-Rapor</h1>
                    <p class="text-gray-700 leading-relaxed">
                        Aplikasi ini dirancang untuk memudahkan pengelolaan data rapor siswa di UPT SDN 22 Tanah Keras.
                        Silakan gunakan navigasi di sisi kiri (atau bawah pada perangkat seluler) untuk mengakses berbagai fitur.
                    </p>
                    <!-- MODIFIKASI: Menggunakan dynamic color classes -->
                    <div id="beranda-info-box" class="mt-8 p-6 border rounded-lg shadow-md color-blue-light color-blue-border">
                        <h2 id="beranda-info-title" class="text-xl font-semibold mb-4 color-blue-text">Informasi Pengguna Aktif:</h2>
                        <p class="text-gray-700">Username: <span id="current-username" class="font-medium"></span></p>
                        <p class="text-gray-700">Peran: <span id="current-role" class="font-medium"></span></p>
                        <p class="text-gray-700" id="current-class-info">Kelas: <span id="current-class" class="font-medium"></span></p>
                    </div>
                </section>

                <!-- Data Sekolah Section (Now accessible by Guru for editing) -->
                <section id="data-sekolah" class="content-section hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Data Sekolah</h1>
                    <form id="form-data-sekolah" class="bg-white p-6 rounded-lg shadow-md">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-group">
                                <label for="nama-sekolah">Nama Sekolah:</label>
                                <input type="text" id="nama-sekolah" required>
                            </div>
                            <div class="form-group">
                                <label for="npsn">NPSN:</label>
                                <input type="text" id="npsn" required>
                            </div>
                            <div class="form-group col-span-full">
                                <label for="alamat-sekolah">Alamat Sekolah:</label>
                                <textarea id="alamat-sekolah" rows="3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="email-sekolah">Email:</label>
                                <input type="email" id="email-sekolah" required>
                            </div>
                            <div class="form-group">
                                <label for="website-sekolah">Website:</label>
                                <input type="url" id="website-sekolah">
                            </div>
                            <div class="form-group">
                                <label for="nama-kepala">Nama Kepala:</label>
                                <input type="text" id="nama-kepala" required>
                            </div>
                            <div class="form-group">
                                <label for="nip-kepala">NIP Kepala:</label>
                                <input type="text" id="nip-kepala">
                            </div>
                            <div class="form-group">
                                <label for="tahun-pelajaran">Tahun Pelajaran:</label>
                                <input type="text" id="tahun-pelajaran" placeholder="Contoh: 2023/2024" required>
                            </div>
                            <div class="form-group">
                                <label for="fase">Fase:</label>
                                <input type="text" id="fase" placeholder="Contoh: A" required>
                            </div>
                            <div class="form-group">
                                <label for="semester">Semester:</label>
                                <select id="semester" required>
                                    <option value="1">Ganjil (1)</option>
                                    <option value="2">Genap (2)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="tanggal-rapor">Tanggal Rapor:</label>
                                <input type="date" id="tanggal-rapor" required>
                            </div>
                        </div>
                        <button type="submit" class="btn-primary mt-6" id="save-data-sekolah-btn">Simpan Data Sekolah</button>
                    </form>
                </section>

                <!-- Data Wali Kelas Section -->
                <section id="data-walas" class="content-section hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Data Wali Kelas</h1>
                    <form id="form-data-walas" class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <input type="hidden" id="walas-id">
                        <div class="form-group">
                            <label for="nama-walas">Nama Wali Kelas:</label>
                            <input type="text" id="nama-walas" required>
                        </div>
                        <div class="form-group">
                            <label for="nip-walas">NIP:</label>
                            <input type="text" id="nip-walas">
                        </div>
                        <div class="form-group">
                            <label for="kelas-walas">Kelas yang Diajar:</label>
                            <select id="kelas-walas" required>
                                <option value="">-- Pilih Kelas --</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                            </select>
                        </div>
                        <button type="submit" class="btn-primary">Simpan Wali Kelas</button>
                    </form>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Daftar Wali Kelas</h2>
                        <div class="overflow-x-auto">
                            <table id="table-data-walas">
                                <thead>
                                    <tr>
                                        <th>Nama Wali Kelas</th>
                                        <th>NIP</th>
                                        <th>Kelas</th>
                                        <th class="no-print">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded here by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Data Siswa Section -->
                <section id="data-siswa" class="content-section hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Data Siswa</h1>
                    <form id="form-data-siswa" class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <input type="hidden" id="siswa-id">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-group">
                                <label for="nama-siswa">Nama Siswa:</label>
                                <input type="text" id="nama-siswa" required>
                            </div>
                            <div class="form-group">
                                <label for="kelas-siswa">Kelas:</label>
                                <input type="text" id="kelas-siswa" required readonly>
                            </div>
                            <div class="form-group">
                                <label for="nisn-nis">NISN/NIS:</label>
                                <input type="text" id="nisn-nis" required>
                            </div>
                            <div class="form-group">
                                <label for="tempat-lahir">Tempat Lahir:</label>
                                <input type="text" id="tempat-lahir">
                            </div>
                            <div class="form-group">
                                <label for="tanggal-lahir">Tanggal Lahir:</label>
                                <input type="date" id="tanggal-lahir">
                            </div>
                            <div class="form-group">
                                <label for="jenis-kelamin">Jenis Kelamin:</label>
                                <select id="jenis-kelamin">
                                    <option value="">-- Pilih --</option>
                                    <option value="Laki-laki">Laki-laki</option>
                                    <option value="Perempuan">Perempuan</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="agama">Agama:</label>
                                <select id="agama">
                                    <option value="">-- Pilih --</option>
                                    <option value="Islam">Islam</option>
                                    <option value="Kristen">Kristen</option>
                                    <option value="Katolik">Katolik</option>
                                    <option value="Hindu">Hindu</option>
                                    <option value="Buddha">Buddha</option>
                                    <option value="Konghucu">Konghucu</option>
                                </select>
                            </div>
                            <div class="form-group col-span-full">
                                <label for="alamat-siswa">Alamat:</label>
                                <textarea id="alamat-siswa" rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="nama-ayah">Nama Ayah:</label>
                                <input type="text" id="nama-ayah">
                            </div>
                            <div class="form-group">
                                <label for="nama-ibu">Nama Ibu:</label>
                                <input type="text" id="nama-ibu">
                            </div>
                            <div class="form-group class1-only">
                                <label for="pekerjaan-ayah">Pekerjaan Ayah:</label>
                                <input type="text" id="pekerjaan-ayah">
                            </div>
                            <div class="form-group class1-only">
                                <label for="pekerjaan-ibu">Pekerjaan Ibu:</label>
                                <input type="text" id="pekerjaan-ibu">
                            </div>
                            <div class="form-group class1-only">
                                <label for="pendidikan-ayah">Pendidikan Ayah:</label>
                                <input type="text" id="pendidikan-ayah">
                            </div>
                            <div class="form-group class1-only">
                                <label for="pendidikan-ibu">Pendidikan Ibu:</label>
                                <input type="text" id="pendidikan-ibu">
                            </div>
                            <div class="form-group class1-only">
                                <label for="no-hp">No. HP:</label>
                                <input type="text" id="no-hp">
                            </div>
                            <div class="form-group class1-only">
                                <label for="kenagarian">Kenagarian:</label>
                                <input type="text" id="kenagarian">
                            </div>
                            <div class="form-group class1-only">
                                <label for="kecamatan">Kecamatan:</label>
                                <input type="text" id="kecamatan">
                            </div>
                            <div class="form-group class1-only">
                                <label for="kabupaten">Kabupaten:</label>
                                <input type="text" id="kabupaten">
                            </div>
                        </div>
                        <button type="submit" class="btn-primary mt-6">Simpan Siswa</button>
                    </form>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Daftar Siswa</h2>
                        <div class="overflow-x-auto">
                            <table id="table-data-siswa">
                                <thead>
                                    <tr>
                                        <th>Nama Siswa</th>
                                        <th>Kelas</th>
                                        <th>NISN/NIS</th>
                                        <th>Tempat/Tgl Lahir</th>
                                        <th>Jenis Kelamin</th>
                                        <th>Agama</th>
                                        <th>Alamat</th>
                                        <th>Nama Ayah</th>
                                        <th>Nama Ibu</th>
                                        <th class="class1-only-table hidden">Pekerjaan Ayah</th>
                                        <th class="class1-only-table hidden">Pekerjaan Ibu</th>
                                        <th class="class1-only-table hidden">Pendidikan Ayah</th>
                                        <th class="class1-only-table hidden">Pendidikan Ibu</th>
                                        <th class="class1-only-table hidden">No. HP</th>
                                        <th class="class1-only-table hidden">Kenagarian</th>
                                        <th class="class1-only-table hidden">Kecamatan</th>
                                        <th class="class1-only-table hidden">Kabupaten</th>
                                        <th class="no-print">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded here by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- New section for Import Data Siswa -->
                <section id="import-data-siswa" class="content-section hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Impor Data Siswa dari Excel</h1>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <p class="text-gray-700 mb-4">
                            Silakan unggah file Excel (.xlsx atau .xls) yang berisi data siswa.
                            Pastikan kolom-kolom berikut ada di lembar pertama file Excel Anda (nama kolom harus persis sama):
                            <span class="font-semibold">Nama Siswa, Kelas, NISN/NIS, Tempat Lahir, Tanggal Lahir, Jenis Kelamin, Agama, Alamat, Nama Ayah, Nama Ibu, Pekerjaan Ayah, Pekerjaan Ibu, Pendidikan Ayah, Pendidikan Ibu, No. HP, Kenagarian, Kecamatan, Kabupaten</span>.
                        </p>
                        <div class="form-group">
                            <label for="excel-file-input">Pilih File Excel:</label>
                            <input type="file" id="excel-file-input" accept=".xlsx, .xls" class="w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <button id="import-excel-btn" class="btn-primary mt-4">Impor Data</button>
                        <pre id="import-status" class="mt-4 text-sm text-gray-600 hidden whitespace-pre-wrap"></pre>
                    </div>
                </section>

                <!-- Mata Pelajaran Section -->
                <section id="mata-pelajaran" class="content-section hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Mata Pelajaran</h1>
                    <form id="form-mata-pelajaran" class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <input type="hidden" id="mapel-id">
                        <div class="form-group">
                            <label for="nama-mapel">Nama Mata Pelajaran:</label>
                            <input type="text" id="nama-mapel" required>
                        </div>
                        <button type="submit" class="btn-primary">Simpan Mata Pelajaran</button>
                    </form>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Daftar Mata Pelajaran</h2>
                        <div class="overflow-x-auto">
                            <table id="table-mata-pelajaran">
                                <thead>
                                    <tr>
                                        <th>Nama Mata Pelajaran</th>
                                        <th class="no-print">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded here by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Ekstrakurikuler Section -->
                <section id="ekstrakurikuler" class="content-section hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Ekstrakurikuler</h1>
                    <form id="form-ekstrakurikuler" class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <input type="hidden" id="ekskul-id">
                        <div class="form-group">
                            <label for="ekskul-siswa-select">Nama Siswa:</label>
                            <select id="ekskul-siswa-select" required></select>
                        </div>
                        <div class="form-group">
                            <label for="nama-ekskul">Ekstrakurikuler:</label>
                            <input type="text" id="nama-ekskul" required>
                        </div>
                        <div class="form-group">
                            <label for="keterangan-ekskul">Keterangan:</label>
                            <textarea id="keterangan-ekskul" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn-primary">Simpan Ekstrakurikuler</button>
                    </form>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Daftar Ekstrakurikuler Siswa</h2>
                        <div class="overflow-x-auto">
                            <table id="table-ekstrakurikuler">
                                <thead>
                                    <tr>
                                        <th>Nama Siswa</th>
                                        <th>Ekstrakurikuler</th>
                                        <th>Keterangan</th>
                                        <th class="no-print">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded here by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Kokurikuler Section -->
                <section id="kokurikuler" class="content-section hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Kokurikuler</h1>
                    <form id="form-kokurikuler" class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <input type="hidden" id="kokur-id">
                        <div class="form-group">
                            <label for="kokur-siswa-select">Nama Siswa:</label>
                            <select id="kokur-siswa-select" required></select>
                        </div>
                        <div class="form-group">
                            <label for="nama-kokur">Kokurikuler:</label>
                            <input type="text" id="nama-kokur" required>
                        </div>
                        <button type="submit" class="btn-primary">Simpan Kokurikuler</button>
                    </form>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Daftar Kokurikuler Siswa</h2>
                        <div class="overflow-x-auto">
                            <table id="table-kokurikuler">
                                <thead>
                                    <tr>
                                        <th>Nama Siswa</th>
                                        <th>Kokurikuler</th>
                                        <th class="no-print">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded here by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Tujuan Pembelajaran Section -->
                <section id="tujuan-pembelajaran" class="content-section hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Tujuan Pembelajaran</h1>
                    <form id="form-tujuan-pembelajaran" class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <input type="hidden" id="tp-id">
                        <div class="form-group">
                            <label for="tp-siswa-select">Nama Siswa:</label>
                            <select id="tp-siswa-select" required></select>
                        </div>
                        <div class="form-group">
                            <label for="tp-mapel-select">Mata Pelajaran:</label>
                            <select id="tp-mapel-select" required></select>
                        </div>
                        <div class="form-group">
                            <label for="tujuan-pembelajaran-text">Tujuan Pembelajaran:</label>
                            <textarea id="tujuan-pembelajaran-text" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn-primary">Simpan Tujuan Pembelajaran</button>
                    </form>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Daftar Tujuan Pembelajaran</h2>
                        <div class="overflow-x-auto">
                            <table id="table-tujuan-pembelajaran">
                                <thead>
                                    <tr>
                                        <th>Nama Siswa</th>
                                        <th>Mata Pelajaran</th>
                                        <th>Tujuan Pembelajaran</th>
                                        <th class="no-print">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded here by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Input Nilai Section -->
                <section id="input-nilai" class="content-section hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Input Nilai</h1>
                    <form id="form-input-nilai" class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <input type="hidden" id="nilai-id">
                        <div class="form-group">
                            <label for="nilai-siswa-select">Nama Siswa:</label>
                            <select id="nilai-siswa-select" required></select>
                        </div>
                        <div class="form-group">
                            <label for="nilai-mapel-select">Mata Pelajaran:</label>
                            <select id="nilai-mapel-select" required></select>
                        </div>
                        <div class="form-group">
                            <label for="nilai-akhir">Nilai Akhir:</label>
                            <input type="number" id="nilai-akhir" min="0" max="100" required>
                        </div>
                        <div class="form-group">
                            <label for="capaian-kompetensi">Capaian Kompetensi:</label>
                            <textarea id="capaian-kompetensi" rows="3" readonly placeholder="Akan terisi otomatis dari Tujuan Pembelajaran"></textarea>
                        </div>
                        <button type="submit" class="btn-primary">Simpan Nilai</button>
                    </form>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Daftar Nilai Siswa</h2>
                        <div class="overflow-x-auto">
                            <table id="table-input-nilai">
                                <thead>
                                    <tr>
                                        <th>Nama Siswa</th>
                                        <th>Mata Pelajaran</th>
                                        <th>Nilai Akhir</th>
                                        <th>Capaian Kompetensi</th>
                                        <th class="no-print">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded here by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Ketidakhadiran Section -->
                <section id="ketidakhadiran" class="content-section hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Ketidakhadiran</h1>
                    <form id="form-ketidakhadiran" class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <input type="hidden" id="absensi-id">
                        <div class="form-group">
                            <label for="absensi-siswa-select">Nama Siswa:</label>
                            <select id="absensi-siswa-select" required></select>
                        </div>
                        <div class="form-group">
                            <label for="jenis-absensi">Absensi:</label>
                            <select id="jenis-absensi" required>
                                <option value="Izin">Izin</option>
                                <option value="Sakit">Sakit</option>
                                <option value="Tanpa Keterangan">Tanpa Keterangan</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="jumlah-absensi">Jumlah Hari:</label>
                            <input type="number" id="jumlah-absensi" min="0" required>
                        </div>
                        <button type="submit" class="btn-primary">Simpan Ketidakhadiran</button>
                    </form>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Daftar Ketidakhadiran Siswa</h2>
                        <div class="overflow-x-auto">
                            <table id="table-ketidakhadiran">
                                <thead>
                                    <tr>
                                        <th>Nama Siswa</th>
                                        <th>Jenis Absensi</th>
                                        <th>Jumlah Hari</th>
                                        <th class="no-print">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded here by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Catatan Wali Kelas Section -->
                <section id="catatan-walas" class="content-section hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Catatan Wali Kelas</h1>
                    <form id="form-catatan-walas" class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <input type="hidden" id="catatan-id">
                        <div class="form-group">
                            <label for="catatan-siswa-select">Nama Siswa:</label>
                            <select id="catatan-siswa-select" required></select>
                        </div>
                        <div class="form-group">
                            <label for="catatan-text">Catatan Wali Kelas:</label>
                            <textarea id="catatan-text" rows="4" required></textarea>
                        </div>
                        <button type="submit" class="btn-primary">Simpan Catatan</button>
                    </form>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Daftar Catatan Wali Kelas</h2>
                        <div class="overflow-x-auto">
                            <table id="table-catatan-walas">
                                <thead>
                                    <tr>
                                        <th>Nama Siswa</th>
                                        <th>Catatan</th>
                                        <th class="no-print">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded here by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Kenaikan Kelas Section -->
                <section id="kenaikan-kelas" class="content-section hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Kenaikan Kelas</h1>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <p class="text-gray-700 mb-4">
                            Fitur kenaikan kelas hanya akan menampilkan status kenaikan kelas pada rapor jika semester yang dipilih pada
                            <span class="font-semibold">Data Sekolah</span> adalah <span class="font-semibold">Genap (2)</span>.
                            Status yang diproses di sini HANYA digunakan untuk tujuan pencetakan Rapor.
                        </p>
                        <div class="form-group">
                            <label for="promote-siswa-select">Pilih Siswa:</label>
                            <select id="promote-siswa-select" class="w-full" required></select>
                        </div>
                        <button id="promote-class-btn" class="btn-primary" disabled>Proses Kenaikan Kelas (untuk Rapor)</button>
                        <p id="promotion-status" class="mt-4 text-red-500 font-medium hidden">
                            Semester saat ini bukan Genap. Fitur kenaikan kelas tidak dapat digunakan.
                        </p>
                        <div id="promotion-results" class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg hidden">
                            <h3 class="text-lg font-semibold mb-2">Hasil Proses Kenaikan Kelas untuk Rapor:</h3>
                            <ul id="promotion-list" class="list-disc list-inside text-gray-700"></ul>
                        </div>
                    </div>
                </section>

                <!-- Cetak Leger Nilai Section -->
                <section id="cetak-leger" class="content-section hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Cetak Leger Nilai</h1>
                    <!-- MODIFIKASI: Menghapus tombol Download PDF -->
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6 flex flex-wrap gap-4 items-end">
                        <button id="print-leger-btn" class="btn-primary no-print w-full md:w-auto">Cetak Leger Nilai</button>
                    </div>
                    <div id="print-area-leger" class="bg-white p-6 rounded-lg shadow-md print-only">
                        <!-- Leger content will be generated here -->
                    </div>
                </section>

                <!-- Cetak Rapor Section -->
                <section id="cetak-rapor" class="content-section hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Cetak Rapor</h1>
                    <!-- MODIFIKASI: Menghapus tombol Download PDF -->
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6 flex flex-wrap gap-4 items-end">
                        <div class="form-group w-full md:w-auto flex-grow">
                            <label for="rapor-siswa-select">Pilih Siswa (Generate per Siswa):</label>
                            <select id="rapor-siswa-select" class="w-full" required></select>
                        </div>
                        <button id="generate-rapor-btn" class="btn-primary no-print w-full md:w-auto">Generate Rapor</button>
                        <button id="generate-rapor-massal-btn" class="btn-secondary no-print w-full md:w-auto">Generate Rapor Semua Siswa</button>
                        <button id="print-rapor-btn" class="btn-primary no-print hidden ml-4 w-full md:w-auto md:ml-0">Cetak Rapor</button>
                    </div>
                    <div id="print-area-rapor" class="bg-white p-6 rounded-lg shadow-md print-only">
                        <!-- Rapor content will be generated here -->
                    </div>
                </section>

                <!-- Cetak Identitas Siswa Section -->
                <section id="cetak-identitas-siswa" class="content-section hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Cetak Identitas Siswa</h1>
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <div class="form-group">
                            <label for="identitas-siswa-select">Pilih Siswa:</label>
                            <select id="identitas-siswa-select" class="w-full" required></select>
                        </div>
                        <button id="generate-identitas-btn" class="btn-primary no-print">Generate Identitas</button>
                        <button id="print-identitas-btn" class="btn-primary no-print hidden ml-4">Cetak Identitas</button>
                    </div>
                    <div id="print-area-identitas" class="bg-white p-6 rounded-lg shadow-md print-only">
                        <!-- Identity card content will be generated here -->
                    </div>
                </section>

                <!-- Manajemen Pengguna Section (Admin Only) -->
                <section id="manajemen-pengguna" class="content-section hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Manajemen Pengguna</h1>
                    <form id="form-manajemen-pengguna" class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <input type="hidden" id="user-id">
                        <div class="form-group">
                            <label for="new-username">Username:</label>
                            <input type="text" id="new-username" required>
                        </div>
                        <div class="form-group">
                            <label for="new-password">Password:</label>
                            <input type="password" id="new-password" required>
                        </div>
                        <div class="form-group">
                            <label for="new-role">Peran:</label>
                            <select id="new-role" required>
                                <option value="Admin">Admin</option>
                                <option value="Guru Kelas 1">Guru Kelas 1</option>
                                <option value="Guru Kelas 2">Guru Kelas 2</option>
                                <option value="Guru Kelas 3">Guru Kelas 3</option>
                                <option value="Guru Kelas 4">Guru Kelas 4</option>
                                <option value="Guru Kelas 5">Guru Kelas 5</option>
                                <option value="Guru Kelas 6">Guru Kelas 6</option>
                            </select>
                        </div>
                        <button type="submit" class="btn-primary">Simpan Pengguna</button>
                    </form>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Daftar Pengguna</h2>
                        <div class="overflow-x-auto">
                            <table id="table-manajemen-pengguna">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Peran</th>
                                        <th class="no-print">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded here by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Pengaturan Section (Admin Only) -->
                <section id="pengaturan" class="content-section hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Pengaturan Aplikasi</h1>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Bagikan Tautan Aplikasi</h2>
                        <p class="text-gray-700 mb-4">
                            Aplikasi ini bekerja secara offline dan menyimpan data di browser Anda (`localStorage`).
                            Membagikan tautan hanya akan membagikan aplikasi itu sendiri,
                            bukan data yang tersimpan di browser Anda.
                        </p>
                        <div class="form-group">
                            <label for="share-link">Tautan Aplikasi:</label>
                            <input type="text" id="share-link" class="bg-gray-100 cursor-text" readonly>
                        </div>
                        <button id="copy-link-btn" class="btn-primary">Salin Tautan</button>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md mt-6">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Opsi Data Global</h2>
                         <button id="backup-data-btn-mobile" class="btn-primary"><i class="fas fa-download"></i> Backup Data</button>
                         <button id="restore-data-btn-mobile" class="btn-primary ml-4"><i class="fas fa-upload"></i> Pulihkan Data</button>
                         <p class="text-sm text-gray-500 mt-2">Gunakan fitur ini untuk menyimpan atau memuat semua data dari dan ke perangkat Anda.</p>
                    </div>
                </section>

            </main>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <p id="modal-message" class="text-lg font-semibold mb-6">Apakah Anda yakin ingin menghapus data ini?</p>
            <button id="confirm-delete-btn" class="btn-danger mr-4">Ya, Hapus</button>
            <button id="cancel-delete-btn" class="btn-secondary">Batal</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="toast"></div>

    <script>
        // --- Global Variables and Initial Data Setup ---
        const LS_PREFIX = 'erapor_sdn22_'; // Prefix for localStorage keys
        let currentUser = null; // Stores current logged-in user
        let currentUsername = null;
        let currentRole = null;
        let currentClass = null; // For Guru roles

        // Data structures (will be loaded from localStorage or initialized)
        let dataSekolah = {};
        let dataWalas = [];
        let dataSiswa = [];
        let dataMapel = [];
        let dataEkskul = [];
        let dataKokur = [];
        let dataTujuanPembelajaran = [];
        let dataNilai = [];
        let dataKetidakhadiran = [];
        let dataCatatanWalas = [];
        let dataUsers = []; // For Manajemen Pengguna

        // --- DOM Elements ---
        const loginPage = document.getElementById('login-page');
        const appContainer = document.getElementById('app-container');
        const appSidebar = document.getElementById('app-sidebar'); // NEW
        const appHeader = document.getElementById('app-header');   // NEW
        const berandaInfoBox = document.getElementById('beranda-info-box'); // NEW
        const berandaInfoTitle = document.getElementById('beranda-info-title'); // NEW
        const pdfLoadingOverlay = document.getElementById('pdf-loading-overlay'); // NEW: PDF overlay
        const loginForm = document.getElementById('login-form');
        const loginFormMobile = document.getElementById('login-form-mobile'); // Mobile form
        const loginError = document.getElementById('login-error');
        const loginErrorMobile = document.getElementById('login-error-mobile'); // Mobile error
        const sidebarItems = document.querySelectorAll('.sidebar-item');
        const contentSections = document.querySelectorAll('.content-section');
        const currentUsernameSpan = document.getElementById('current-username');
        const currentRoleSpan = document.getElementById('current-role');
        const currentClassInfoDiv = document.getElementById('current-class-info');
        const currentClassSpan = document.getElementById('current-class');
        const logoutBtn = document.getElementById('logout-btn');
        // Desktop backup/restore buttons (hidden on mobile sidebar)
        const backupDataBtn = document.getElementById('backup-data-btn');
        const restoreDataBtn = document.getElementById('restore-data-btn');
        // Mobile backup/restore buttons (shown in Pengaturan section)
        const backupDataBtnMobile = document.getElementById('backup-data-btn-mobile');
        const restoreDataBtnMobile = document.getElementById('restore-data-btn-mobile');

        const confirmationModal = document.getElementById('confirmation-modal');
        const modalMessage = document.getElementById('modal-message');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const closeModalBtn = document.querySelector('#confirmation-modal .close-button');
        const toastNotification = document.getElementById('toast-notification');

        // Forms and Tables
        const formDataSekolah = document.getElementById('form-data-sekolah');
        const tableDataWalas = document.getElementById('table-data-walas').querySelector('tbody');
        const formDataWalas = document.getElementById('form-data-walas');
        const kelasWalasSelect = document.getElementById('kelas-walas'); // New element
        const tableDataSiswa = document.getElementById('table-data-siswa').querySelector('tbody');
        const formDataSiswa = document.getElementById('form-data-siswa');
        const tableMataPelajaran = document.getElementById('table-mata-pelajaran').querySelector('tbody');
        const formMataPelajaran = document.getElementById('form-mata-pelajaran');
        const tableEkstrakurikuler = document.getElementById('table-ekstrakurikuler').querySelector('tbody');
        const formEkstrakurikuler = document.getElementById('form-ekstrakurikuler');
        const ekskulSiswaSelect = document.getElementById('ekskul-siswa-select');
        const tableKokurikuler = document.getElementById('table-kokurikuler').querySelector('tbody');
        const formKokurikuler = document.getElementById('form-kokurikuler');
        const kokurSiswaSelect = document.getElementById('kokur-siswa-select');
        const tableTujuanPembelajaran = document.getElementById('table-tujuan-pembelajaran').querySelector('tbody');
        const formTujuanPembelajaran = document.getElementById('form-tujuan-pembelajaran');
        const tpSiswaSelect = document.getElementById('tp-siswa-select');
        const tpMapelSelect = document.getElementById('tp-mapel-select');
        const tableInputNilai = document.getElementById('table-input-nilai').querySelector('tbody');
        const formInputNilai = document.getElementById('form-input-nilai');
        const nilaiSiswaSelect = document.getElementById('nilai-siswa-select');
        const nilaiMapelSelect = document.getElementById('nilai-mapel-select');
        const capaianKompetensiTextarea = document.getElementById('capaian-kompetensi');
        const tableKetidakhadiran = document.getElementById('table-ketidakhadiran').querySelector('tbody');
        const formKetidakhadiran = document.getElementById('form-ketidakhadiran');
        const absensiSiswaSelect = document.getElementById('absensi-siswa-select');
        const tableCatatanWalas = document.getElementById('table-catatan-walas').querySelector('tbody');
        const formCatatanWalas = document.getElementById('form-catatan-walas');
        const catatanSiswaSelect = document.getElementById('catatan-siswa-select');
        const tableManajemenPengguna = document.getElementById('table-manajemen-pengguna').querySelector('tbody');
        const formManajemenPengguna = document.getElementById('form-manajemen-pengguna');

        const promoteClassBtn = document.getElementById('promote-class-btn');
        const promoteSiswaSelect = document.getElementById('promote-siswa-select'); // New element
        const promotionStatus = document.getElementById('promotion-status');
        const promotionResults = document.getElementById('promotion-results');
        const promotionList = document.getElementById('promotion-list');

        const printLegerBtn = document.getElementById('print-leger-btn');
        // const downloadLegerPdfBtn = document.getElementById('download-leger-pdf-btn'); // REMOVED
        const printAreaLeger = document.getElementById('print-area-leger');
        const raporSiswaSelect = document.getElementById('rapor-siswa-select');
        const generateRaporBtn = document.getElementById('generate-rapor-btn');
        const generateRaporMassalBtn = document.getElementById('generate-rapor-massal-btn'); // New element
        const printRaporBtn = document.getElementById('print-rapor-btn');
        // const downloadRaporPdfBtn = document.getElementById('download-rapor-pdf-btn'); // REMOVED
        const printAreaRapor = document.getElementById('print-area-rapor');

        // Elements for Identitas Siswa
        const identitasSiswaSelect = document.getElementById('identitas-siswa-select');
        const generateIdentitasBtn = document.getElementById('generate-identitas-btn');
        const printIdentitasBtn = document.getElementById('print-identitas-btn');
        const printAreaIdentitas = document.getElementById('print-area-identitas');

        // Elements for Import Data Siswa
        const excelFileInput = document.getElementById('excel-file-input');
        const importExcelBtn = document.getElementById('import-excel-btn');
        const importStatusDiv = document.getElementById('import-status');

        const shareLinkInput = document.getElementById('share-link');
        const copyLinkBtn = document.getElementById('copy-link-btn');

        // --- Color Mapping ---
        const CLASS_COLORS = {
            '1': 'green',
            '2': 'yellow',
            '3': 'red',
            '4': 'purple',
            '5': 'magenta',
            '6': 'gray',
            'Admin': 'blue'
        };

        const COLOR_CLASSES = ['color-green-bg', 'color-yellow-bg', 'color-red-bg', 'color-purple-bg', 'color-magenta-bg', 'color-gray-bg', 'color-blue-bg'];
        const LIGHT_COLORS = ['color-green-light', 'color-yellow-light', 'color-red-light', 'color-purple-light', 'color-magenta-light', 'color-gray-light', 'color-blue-light'];
        const TEXT_COLORS = ['color-green-text', 'color-yellow-text', 'color-red-text', 'color-purple-text', 'color-magenta-text', 'color-gray-text', 'color-blue-text'];
        const BORDER_COLORS = ['color-green-border', 'color-yellow-border', 'color-red-border', 'color-purple-border', 'color-magenta-border', 'color-gray-border', 'color-blue-border'];

        // --- Utility Functions ---

        // Function to remove all color classes from an element
        function removeColorClasses(element) {
            if (element) {
                element.classList.remove(...COLOR_CLASSES, ...LIGHT_COLORS, ...TEXT_COLORS, ...BORDER_COLORS);
            }
        }
        
        // Function to apply colors based on role/class
        function applyColorTheme(colorName) {
            const bgClass = `color-${colorName}-bg`;
            const lightClass = `color-${colorName}-light`;
            const textClass = `color-${colorName}-text`;
            const borderClass = `color-${colorName}-border`;
            
            // Remove all existing color classes first
            removeColorClasses(appSidebar);
            removeColorClasses(berandaInfoBox);
            removeColorClasses(berandaInfoTitle);
            
            // Apply main background color to sidebar
            appSidebar.classList.add(bgClass);
            
            // Apply light background and text/border colors to Beranda info box
            if (berandaInfoBox) {
                 berandaInfoBox.classList.add(lightClass, 'border'); // Add border utility
                 berandaInfoBox.classList.add(borderClass.replace('-bg', '-border')); // Apply border color
            }
            if (berandaInfoTitle) {
                 berandaInfoTitle.classList.add(textClass);
            }
            
            // Apply hover/active styles dynamically to sidebar items
            sidebarItems.forEach(item => {
                removeColorClasses(item);
                const hoverClass = `color-${colorName}-hover`;
                const activeClass = `color-${colorName}-active`;
                
                // We add event listeners to manually swap hover/active colors
                item.onmouseover = function() {
                    if (!this.classList.contains('active')) {
                        removeColorClasses(this);
                        this.classList.add(hoverClass);
                    }
                };
                item.onmouseout = function() {
                    if (!this.classList.contains('active')) {
                        removeColorClasses(this);
                    }
                };
                item.onclick = function() {
                    // Re-apply active class to new active item
                    document.querySelectorAll('.sidebar-item').forEach(i => {
                        i.classList.remove('active', activeClass, hoverClass);
                        removeColorClasses(i); // Clear all colors on deactivation
                        i.style.backgroundColor = ''; // Clear inline styles
                    });
                    this.classList.add('active', activeClass);
                    removeColorClasses(this);
                    this.classList.add(activeClass);
                }
            });
        }

        // Function to show toast notification
        function showToast(message, isError = false) {
            toastNotification.textContent = message;
            toastNotification.style.backgroundColor = isError ? '#ef4444' : '#4CAF50';
            toastNotification.classList.add('show');
            setTimeout(() => {
                toastNotification.classList.remove('show');
            }, 3000);
        }

        // Function to generate unique ID
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Function to save data to localStorage
        function saveData(key, data) {
            localStorage.setItem(LS_PREFIX + key, JSON.stringify(data));
        }

        // Function to load data from localStorage
        function loadData(key, defaultValue = []) {
            const data = localStorage.getItem(LS_PREFIX + key);
            return data ? JSON.parse(data) : defaultValue;
        }

        // Function to clear a form
        function clearForm(form) {
            form.reset();
            const hiddenIdInput = form.querySelector('input[type="hidden"]');
            if (hiddenIdInput) {
                hiddenIdInput.value = '';
            }
        }

        // Function to populate dropdowns (select elements)
        function populateSelect(selectElement, dataArray, valueKey, textKey, selectedValue = null) {
            selectElement.innerHTML = '<option value="">-- Pilih --</option>';
            dataArray.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueKey];
                option.textContent = item[textKey];
                if (selectedValue && item[valueKey] === selectedValue) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
        }

        // --- Data Loading and Initialization ---
        function loadAllData() {
            dataSekolah = loadData('dataSekolah', {
                namaSekolah: 'UPT SDN 22 Tanah Keras',
                npsn: '10301884',
                email: 'UPTsdn22tanahkeras@gmail.com',
                website: 'https://www.sdn22tk.my.id',
                semester: '1' // Default semester
            });
            // Ensure classes are assigned to existing walas on load if possible (best practice: assign via form)
            dataWalas = loadData('dataWalas');
            dataSiswa = loadData('dataSiswa');
            dataMapel = loadData('dataMapel');
            dataEkskul = loadData('dataEkskul');
            dataKokur = loadData('dataKokur');
            dataTujuanPembelajaran = loadData('dataTujuanPembelajaran');
            dataNilai = loadData('dataNilai');
            dataKetidakhadiran = loadData('dataKetidakhadiran');
            dataCatatanWalas = loadData('dataCatatanWalas');
            dataUsers = loadData('dataUsers', [
                { id: 'Admin1', username: 'Admin', password: '12345', role: 'Admin' },
                { id: 'guru1', username: 'Yelmi Putri, S.Pd', password: '12345', role: 'Guru Kelas 1' },
                { id: 'guru2', username: 'Doni Candra, S.Pd', password: '12345', role: 'Guru Kelas 2' },
                { id: 'guru3', username: 'Neldawati, S.Pd.SD', password: '12345', role: 'Guru Kelas 3' },
                { id: 'guru4', username: 'Iismaleni, S.Pd', password: '12345', role: 'Guru Kelas 4' },
                { id: 'guru5', username: 'Yola Yurmaliza, S.Pd', password: '12345', role: 'Guru Kelas 5' },
                { id: 'guru6', username: 'Nurdasmi, S.Pd.SD', password: '12345', role: 'Guru Kelas 6' }
            ]);
        }

        // --- Authentication and Authorization ---
        function checkLoginStatus() {
            currentUser = loadData('currentUser', null);
            if (currentUser) {
                currentUsername = currentUser.username;
                currentRole = currentUser.role;
                currentClass = currentUser.role.includes('Guru Kelas') ? currentUser.role.split(' ')[2] : null; // Ensure currentClass is set here
                // Re-find walasId on load as dataWalas might have changed
                if (currentClass) {
                    const walasForClass = dataWalas.find(w => w.kelas === currentClass);
                    currentUser.walasId = walasForClass ? walasForClass.id : null;
                } else {
                    currentUser.walasId = null;
                }
                
                loginPage.classList.add('hidden');
                appContainer.classList.remove('hidden');
                updateUIForRole();
                displayUserInfo();
                activateSection('beranda'); // Default to Beranda
            } else {
                loginPage.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        }

        // Single login handler for both desktop and mobile
        function handleLogin(event, isMobile = false) {
            event.preventDefault();
            
            const username = isMobile ? document.getElementById('username-mobile').value : document.getElementById('username').value;
            const password = isMobile ? document.getElementById('password-mobile').value : document.getElementById('password').value;
            const role = isMobile ? document.getElementById('role-select-mobile').value : document.getElementById('role-select').value;
            const errorDiv = isMobile ? loginErrorMobile : loginError;

            const user = dataUsers.find(u => u.username === username && u.password === password && u.role === role);

            if (user) {
                currentUser = user;
                currentUsername = user.username;
                currentRole = user.role;
                currentClass = user.role.includes('Guru Kelas') ? user.role.split(' ')[2] : null;

                if (currentClass) {
                    const walasForClass = dataWalas.find(w => w.kelas === currentClass);
                    if (walasForClass) {
                        currentUser.walasId = walasForClass.id;
                    } else {
                        currentUser.walasId = null;
                        showToast(`Tidak ada data Wali Kelas yang terdaftar untuk Kelas ${currentClass}. Harap hubungi Admin.`, true);
                    }
                } else {
                    currentUser.walasId = null;
                }

                saveData('currentUser', { 
                    id: currentUser.id, 
                    username: currentUsername, 
                    role: currentRole, 
                    class: currentClass, 
                    walasId: currentUser.walasId 
                });
                errorDiv.classList.add('hidden');
                loginPage.classList.add('hidden');
                appContainer.classList.remove('hidden');
                updateUIForRole();
                displayUserInfo();
                activateSection('beranda');
                showToast('Login berhasil!');
            } else {
                errorDiv.classList.remove('hidden');
                showToast('Username atau password salah!', true);
            }
        }

        function handleLogout() {
            saveData('currentUser', null); // Clear current user
            currentUser = null;
            currentUsername = null;
            currentRole = null;
            currentClass = null;
            loginPage.classList.remove('hidden');
            appContainer.classList.add('hidden');
            showToast('Anda telah logout.');
        }

        function updateUIForRole() {
            const isAdmin = currentRole === 'Admin';
            const isGuruKelas1 = currentRole === 'Guru Kelas 1';
            const isGuru = currentRole && currentRole.startsWith('Guru Kelas');
            
            // --- COLOR LOGIC START ---
            let colorKey = 'blue'; // Default for Admin
            if (isGuru && currentClass) {
                colorKey = CLASS_COLORS[currentClass] || 'blue';
            }
            applyColorTheme(colorKey);
            // --- COLOR LOGIC END ---


            // Hide/show Admin-only sidebar items
            document.querySelectorAll('.Admin-only').forEach(item => {
                if (isAdmin) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });

            // Specific form field for Guru (kelas-siswa)
            const kelasSiswaInput = document.getElementById('kelas-siswa');
            if (kelasSiswaInput) { // Ensure element exists
                if (isGuru && currentClass) {
                    kelasSiswaInput.value = currentClass;
                    kelasSiswaInput.readOnly = true;
                    kelasSiswaInput.classList.add('bg-gray-100', 'cursor-not-allowed');
                } else {
                    kelasSiswaInput.value = '';
                    kelasSiswaInput.readOnly = false;
                    kelasSiswaInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                }
            }
            
            // Hide/show class1-only fields in Data Siswa form
            document.querySelectorAll('.class1-only').forEach(item => {
                if (isGuruKelas1 || isAdmin) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });

            // Hide/show class1-only columns in Data Siswa table headers
            document.querySelectorAll('#table-data-siswa th.class1-only-table').forEach(th => {
                if (isGuruKelas1 || isAdmin) { // Admin and Guru Kls 1 can see these columns
                    th.classList.remove('hidden');
                } else {
                    th.classList.add('hidden');
                }
            });

            // Control access to master data forms/tables
            const masterDataSections = ['data-walas', 'mata-pelajaran', 'manajemen-pengguna'];
            sidebarItems.forEach(item => {
                const targetId = item.dataset.target;
                if (masterDataSections.includes(targetId) && !isAdmin) {
                    // For now, allow Guru to view all but restrict forms in subsequent logic if necessary
                }
            });
            
            // Only Admin can manage data walas - **UPDATE START**
            // Now: Admin can manage all. Guru can only manage their own class data.
            // Form is hidden only if it's a Guru and there's no way to assign a class (but here, we assign it automatically below)
            // Let's control the visibility and auto-fill in activateSection or renderDataWalasTable.
            // The form itself should generally be visible to the Guru.
            // We ensure it's hidden from non-Admin only if they are not a guru.
            if (formDataWalas) {
                const isGuru = currentRole && currentRole.startsWith('Guru Kelas');
                if (isGuru || isAdmin) {
                    formDataWalas.classList.remove('hidden');
                } else {
                    // Assuming no other roles need to access this form
                    formDataWalas.classList.add('hidden');
                }
            }
            // Only Admin can manage mapel - **UPDATE START**
            // Now: Guru can also manage mapel (add/edit/delete)
            if (formMataPelajaran) {
                const isGuru = currentRole && currentRole.startsWith('Guru Kelas');
                if (isAdmin || isGuru) {
                    formMataPelajaran.classList.remove('hidden');
                } else {
                    formMataPelajaran.classList.add('hidden');
                }
            }
            // **UPDATE END**

            // Show desktop/mobile specific buttons
            if (backupDataBtn) backupDataBtn.classList.remove('hidden');
            if (restoreDataBtn) restoreDataBtn.classList.remove('hidden');
            // Logout button is now always available in the header

            // Hide mobile-only buttons outside their section
            if (backupDataBtnMobile) backupDataBtnMobile.classList.add('hidden');
            if (restoreDataBtnMobile) restoreDataBtnMobile.classList.add('hidden');
            
            // Set the visibility of the Backup/Restore/Logout buttons in the sidebar depending on screen size
            const isMobile = window.innerWidth <= 768;

            if (isMobile) {
                // On mobile, hide the desktop sidebar versions
                if (backupDataBtn) backupDataBtn.classList.add('hidden');
                if (restoreDataBtn) restoreDataBtn.classList.add('hidden');
            } else {
                // On desktop, show the desktop sidebar versions
                if (backupDataBtn) backupDataBtn.classList.remove('hidden');
                if (restoreDataBtn) restoreDataBtn.classList.remove('hidden');
            }
            // The actual logout button in the header is always visible
        }

        function displayUserInfo() {
            currentUsernameSpan.textContent = currentUsername;
            currentRoleSpan.textContent = currentRole;
            if (currentClass) {
                currentClassInfoDiv.classList.remove('hidden');
                currentClassSpan.textContent = currentClass;
            } else {
                currentClassInfoDiv.classList.add('hidden');
            }
        }

        // --- Navigation ---
        function activateSection(sectionId) {
            // Hide all content sections first
            contentSections.forEach(section => {
                section.classList.add('hidden');
            });

            // Show the target section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            } else {
                // Fallback to beranda if target section is not found
                document.getElementById('beranda').classList.remove('hidden');
                const berandaSidebarItem = document.querySelector(`.sidebar-item[data-target="beranda"]`);
                if (berandaSidebarItem) {
                    berandaSidebarItem.classList.add('active');
                }
                showToast('Halaman tidak ditemukan, kembali ke Beranda.', true);
                return;
            }

            // Remove 'active' class from all sidebar items and re-apply colors
            const colorKey = currentRole.startsWith('Guru Kelas') ? CLASS_COLORS[currentClass] || 'blue' : 'blue';
            const activeClass = `color-${colorKey}-active`;

            sidebarItems.forEach(item => {
                if (item && item.classList) {
                    item.classList.remove('active', activeClass, ...COLOR_CLASSES);
                    item.style.backgroundColor = '';
                }
            });

            // Add 'active' class and specific color to the selected sidebar item
            const selectedSidebarItem = document.querySelector(`.sidebar-item[data-target="${sectionId}"]`);
            if (selectedSidebarItem) {
                selectedSidebarItem.classList.add('active', activeClass);
            }
            
            // Handle mobile buttons visibility in Pengaturan
            if (sectionId === 'pengaturan') {
                if (backupDataBtnMobile) backupDataBtnMobile.classList.remove('hidden');
                if (restoreDataBtnMobile) restoreDataBtnMobile.classList.remove('hidden');
            } else {
                if (backupDataBtnMobile) backupDataBtnMobile.classList.add('hidden');
                if (restoreDataBtnMobile) restoreDataBtnMobile.classList.add('hidden');
            }


            // Load data for the active section
            switch (sectionId) {
                case 'data-sekolah':
                    loadDataSekolahForm();
                    updateUIForRole(); // Apply read-only status after loading form
                    break;
                case 'data-walas':
                    renderDataWalasTable();
                    // Auto-fill and disable 'kelas-walas' for Guru roles - **UPDATE START**
                    const kelasWalasSelectElement = document.getElementById('kelas-walas');
                    if (kelasWalasSelectElement) {
                        const isGuru = currentRole && currentRole.startsWith('Guru Kelas');
                        if (isGuru && currentClass) {
                            // Find existing walas data for this class
                            const existingWalas = dataWalas.find(w => w.kelas === currentClass);
                            
                            // If a Guru logs in, their dataWalas should be pre-filled to reflect their role.
                            if (existingWalas) {
                                // If data already exists, populate the form for editing (must be done in render, but let's ensure class is set)
                                kelasWalasSelectElement.value = currentClass;
                                // Automatically load the data of the current Guru's class into the form (if they are Guru)
                                editWalas(existingWalas.id);
                            } else {
                                // If no data exists, pre-fill for creation
                                clearForm(formDataWalas);
                                kelasWalasSelectElement.value = currentClass;
                            }
                            
                            // Always disable class selection for Guru
                            kelasWalasSelectElement.disabled = true;
                            kelasWalasSelectElement.classList.add('bg-gray-100', 'cursor-not-allowed');

                            // Also, auto-fill Nama Wali Kelas and NIP from their user account if available and form is empty
                            if (!document.getElementById('nama-walas').value) {
                                document.getElementById('nama-walas').value = currentUsername;
                            }

                        } else {
                            // Admin or other roles
                            kelasWalasSelectElement.disabled = false;
                            kelasWalasSelectElement.classList.remove('bg-gray-100', 'cursor-not-allowed');
                            clearForm(formDataWalas);
                        }
                    }
                    // **UPDATE END**
                    break;
                case 'data-siswa':
                    renderDataSiswaTable();
                    updateUIForRole(); // Apply visibility for class1-only fields
                    break;
                case 'import-data-siswa':
                    // Clear file input and status message
                    excelFileInput.value = '';
                    importStatusDiv.textContent = '';
                    importStatusDiv.classList.add('hidden');
                    break;
                case 'mata-pelajaran':
                    renderMataPelajaranTable();
                    break;
                case 'ekstrakurikuler':
                    populateSelect(ekskulSiswaSelect, getFilteredSiswa(), 'id', 'namaSiswa');
                    renderEkstrakurikulerTable();
                    break;
                case 'kokurikuler':
                    populateSelect(kokurSiswaSelect, getFilteredSiswa(), 'id', 'namaSiswa');
                    renderKokurikulerTable();
                    break;
                case 'tujuan-pembelajaran':
                    populateSelect(tpSiswaSelect, getFilteredSiswa(), 'id', 'namaSiswa');
                    populateSelect(tpMapelSelect, dataMapel, 'id', 'namaMapel');
                    renderTujuanPembelajaranTable();
                    break;
                case 'input-nilai':
                    populateSelect(nilaiSiswaSelect, getFilteredSiswa(), 'id', 'namaSiswa');
                    populateSelect(nilaiMapelSelect, dataMapel, 'id', 'namaMapel');
                    renderInputNilaiTable();
                    break;
                case 'ketidakhadiran':
                    populateSelect(absensiSiswaSelect, getFilteredSiswa(), 'id', 'namaSiswa');
                    renderKetidakhadiranTable();
                    break;
                case 'catatan-walas':
                    populateSelect(catatanSiswaSelect, getFilteredSiswa(), 'id', 'namaSiswa');
                    renderCatatanWalasTable();
                    break;
                case 'kenaikan-kelas':
                    populateSelect(promoteSiswaSelect, getFilteredSiswa(), 'id', 'namaSiswa'); // Populate student select for promotion
                    checkPromotionEligibility();
                    break;
                case 'cetak-leger':
                    generateLegerNilai();
                    break;
                case 'cetak-rapor':
                    populateSelect(raporSiswaSelect, getFilteredSiswa(), 'id', 'namaSiswa');
                    printRaporBtn.classList.add('hidden'); // Hide print button until rapor is generated
                    // downloadRaporPdfBtn.classList.add('hidden'); // REMOVED
                    printAreaRapor.innerHTML = ''; // Clear previous rapor
                    // Show or hide the Massal button based on currentRole (Admin always sees it)
                    if (currentRole.startsWith('Guru Kelas')) {
                         generateRaporMassalBtn.classList.remove('hidden');
                    } else if (currentRole === 'Admin') {
                         generateRaporMassalBtn.classList.remove('hidden');
                    } else {
                         generateRaporMassalBtn.classList.add('hidden');
                    }
                    break;
                case 'cetak-identitas-siswa':
                    populateSelect(identitasSiswaSelect, getFilteredSiswa(), 'id', 'namaSiswa');
                    printIdentitasBtn.classList.add('hidden'); // Hide print button until identitas is generated
                    printAreaIdentitas.innerHTML = ''; // Clear previous identitas
                    break;
                case 'manajemen-pengguna':
                    renderManajemenPenggunaTable();
                    break;
                case 'pengaturan':
                    shareLinkInput.value = window.location.href.split('#')[0];
                    break;
            }
        }

        // --- Data Filtering for Guru ---
        function getFilteredSiswa() {
            if (currentRole === 'Admin') {
                return dataSiswa;
            } else if (currentClass) {
                return dataSiswa.filter(s => s.kelas === currentClass);
            }
            return [];
        }

        // --- CRUD Operations & Rendering Functions ---

        // Data Sekolah
        function loadDataSekolahForm() {
            document.getElementById('nama-sekolah').value = dataSekolah.namaSekolah || '';
            document.getElementById('npsn').value = dataSekolah.npsn || '10301884'; // Pre-fill NPSN
            document.getElementById('alamat-sekolah').value = dataSekolah.alamatSekolah || '';
            document.getElementById('email-sekolah').value = dataSekolah.email || 'UPTsdn22tanahkeras@gmail.com'; // Pre-fill Email
            document.getElementById('website-sekolah').value = dataSekolah.website || 'https://www.sdn22tk.my.id'; // Pre-fill Website
            document.getElementById('nama-kepala').value = dataSekolah.namaKepala || '';
            document.getElementById('nip-kepala').value = dataSekolah.nipKepala || '';
            document.getElementById('tahun-pelajaran').value = dataSekolah.tahunPelajaran || '';
            document.getElementById('fase').value = dataSekolah.fase || '';
            document.getElementById('semester').value = dataSekolah.semester || '1';
            document.getElementById('tanggal-rapor').value = dataSekolah.tanggalRapor || '';
        }

        formDataSekolah.addEventListener('submit', function(event) {
            event.preventDefault();
            // Removed the Admin-only check here, allowing Guru to save Data Sekolah
            dataSekolah = {
                namaSekolah: document.getElementById('nama-sekolah').value,
                npsn: document.getElementById('npsn').value,
                alamatSekolah: document.getElementById('alamat-sekolah').value,
                email: document.getElementById('email-sekolah').value,
                website: document.getElementById('website-sekolah').value,
                namaKepala: document.getElementById('nama-kepala').value,
                nipKepala: document.getElementById('nip-kepala').value,
                tahunPelajaran: document.getElementById('tahun-pelajaran').value,
                fase: document.getElementById('fase').value,
                semester: document.getElementById('semester').value,
                tanggalRapor: document.getElementById('tanggal-rapor').value
            };
            saveData('dataSekolah', dataSekolah);
            showToast('Data Sekolah berhasil disimpan!');
            checkPromotionEligibility(); // Re-check after semester change
        });

        // Data Wali Kelas
        function renderDataWalasTable() {
            tableDataWalas.innerHTML = '';
            
            // Filter list to show only the current class's walas for Guru, or all for Admin
            const filteredWalas = dataWalas.filter(walas => 
                currentRole === 'Admin' || walas.kelas === currentClass
            );

            filteredWalas.forEach(walas => {
                const row = tableDataWalas.insertRow();
                row.insertCell().textContent = walas.namaWalas;
                row.insertCell().textContent = walas.nipWalas;
                row.insertCell().textContent = walas.kelas || '-'; // Display class
                const actionCell = row.insertCell();
                actionCell.classList.add('no-print');
                
                // Allow Guru to edit their own class data, Admin to edit all
                const canEdit = currentRole === 'Admin' || (currentRole.startsWith('Guru Kelas') && walas.kelas === currentClass);
                const canDelete = currentRole === 'Admin'; // Only Admin can delete

                let actionsHtml = '';
                if (canEdit) {
                    actionsHtml += `<button class="btn-edit" onclick="editWalas('${walas.id}')"><i class="fas fa-edit"></i> Edit</button>`;
                } else {
                    actionsHtml += `<button class="btn-edit opacity-50 cursor-not-allowed" disabled><i class="fas fa-edit"></i> Edit</button>`;
                }
                
                if (canDelete) {
                    actionsHtml += `<button class="btn-danger ml-2" onclick="confirmDelete('walas', '${walas.id}')"><i class="fas fa-trash"></i> Hapus</button>`;
                } else {
                    actionsHtml += `<button class="btn-danger ml-2 opacity-50 cursor-not-allowed" disabled><i class="fas fa-trash"></i> Hapus</button>`;
                }
                
                actionCell.innerHTML = actionsHtml;
            });
            clearForm(formDataWalas);
        }

        formDataWalas.addEventListener('submit', function(event) {
            event.preventDefault();
            const isGuru = currentRole && currentRole.startsWith('Guru Kelas');

            if (!isGuru && currentRole !== 'Admin') {
                showToast('Anda tidak memiliki izin untuk mengubah data Wali Kelas.', true);
                return;
            }
            
            const id = document.getElementById('walas-id').value;
            const newClass = kelasWalasSelect.value;
            
            // Validation for Guru: must match their assigned class
            if (isGuru && newClass !== currentClass) {
                showToast('Anda hanya dapat mengisi data Wali Kelas untuk kelas Anda sendiri.', true);
                return;
            }
            
            const newWalas = {
                namaWalas: document.getElementById('nama-walas').value,
                nipWalas: document.getElementById('nip-walas').value,
                kelas: newClass
            };

            if (id) {
                const index = dataWalas.findIndex(w => w.id === id);
                if (index !== -1) {
                    dataWalas[index] = { ...dataWalas[index], ...newWalas };
                    showToast('Data Wali Kelas berhasil diperbarui!');
                }
            } else {
                // Check if a walas for this class already exists for Admin/new entry
                const existingWalasForClass = dataWalas.find(w => w.kelas === newWalas.kelas && newWalas.kelas);
                if (newWalas.kelas && existingWalasForClass) {
                    showToast(`Wali Kelas untuk Kelas ${newWalas.kelas} sudah ada. Harap edit data yang sudah ada.`, true);
                    return;
                }
                newWalas.id = generateUniqueId();
                dataWalas.push(newWalas);
                showToast('Data Wali Kelas berhasil ditambahkan!');
            }
            saveData('dataWalas', dataWalas);
            renderDataWalasTable();
            
            // Re-update the current user's walasId if they just saved/updated their own record
            if (isGuru) {
                 const walasForClass = dataWalas.find(w => w.kelas === currentClass);
                 if (walasForClass) {
                    currentUser.walasId = walasForClass.id;
                    // Update current user data in local storage
                    saveData('currentUser', { 
                        id: currentUser.id, 
                        username: currentUsername, 
                        role: currentRole, 
                        class: currentClass, 
                        walasId: currentUser.walasId 
                    });
                 }
            }
        });

        function editWalas(id) {
            const walas = dataWalas.find(w => w.id === id);
            if (!walas) return;
            
            const isGuru = currentRole && currentRole.startsWith('Guru Kelas');
            
            // Permission check: Admin can edit all, Guru can edit their own class's data
            if (!currentRole === 'Admin' && (!isGuru || walas.kelas !== currentClass)) {
                showToast('Anda tidak memiliki izin untuk mengedit data ini.', true);
                return;
            }

            if (walas) {
                document.getElementById('walas-id').value = walas.id;
                document.getElementById('nama-walas').value = walas.namaWalas;
                document.getElementById('nip-walas').value = walas.nipWalas;
                kelasWalasSelect.value = walas.kelas || ''; 
                
                // Disable class selection if it's a Guru
                if (isGuru) {
                     kelasWalasSelect.disabled = true;
                     kelasWalasSelect.classList.add('bg-gray-100', 'cursor-not-allowed');
                } else {
                     kelasWalasSelect.disabled = false;
                     kelasWalasSelect.classList.remove('bg-gray-100', 'cursor-not-allowed');
                }
                
                showToast('Form Wali Kelas siap diedit.');
            }
        }
        
        // Data Siswa
        function renderDataSiswaTable() {
            tableDataSiswa.innerHTML = '';
            const filteredSiswa = getFilteredSiswa();
            const isAdmin = currentRole === 'Admin';
            const isGuruKelas1 = currentRole === 'Guru Kelas 1';

            // Update table headers visibility
            document.querySelectorAll('#table-data-siswa th.class1-only-table').forEach(th => {
                if (isGuruKelas1 || isAdmin) {
                    th.classList.remove('hidden');
                } else {
                    th.classList.add('hidden');
                }
            });

            filteredSiswa.forEach(siswa => {
                const row = tableDataSiswa.insertRow();
                row.insertCell().textContent = siswa.namaSiswa;
                row.insertCell().textContent = siswa.kelas;
                row.insertCell().textContent = siswa.nisnNis;
                row.insertCell().textContent = `${siswa.tempatLahir || ''}, ${siswa.tanggalLahir || ''}`;
                row.insertCell().textContent = siswa.jenisKelamin || '-'; 
                row.insertCell().textContent = siswa.agama || '-'; 
                row.insertCell().textContent = siswa.alamat || '';
                row.insertCell().textContent = siswa.namaAyah || '';
                row.insertCell().textContent = siswa.namaIbu || '';

                // Conditionally add cells for class1-only data
                const pekerjaanAyahCell = row.insertCell();
                pekerjaanAyahCell.textContent = siswa.pekerjaanAyah || '-';
                if (!isGuruKelas1 && !isAdmin) pekerjaanAyahCell.classList.add('hidden');

                const pekerjaanIbuCell = row.insertCell();
                pekerjaanIbuCell.textContent = siswa.pekerjaanIbu || '-';
                if (!isGuruKelas1 && !isAdmin) pekerjaanIbuCell.classList.add('hidden');

                const pendidikanAyahCell = row.insertCell();
                pendidikanAyahCell.textContent = siswa.pendidikanAyah || '-';
                if (!isGuruKelas1 && !isAdmin) pendidikanAyahCell.classList.add('hidden');

                const pendidikanIbuCell = row.insertCell();
                pendidikanIbuCell.textContent = siswa.pendidikanIbu || '-';
                if (!isGuruKelas1 && !isAdmin) pendidikanIbuCell.classList.add('hidden');

                const noHpCell = row.insertCell();
                noHpCell.textContent = siswa.noHp || '-';
                if (!isGuruKelas1 && !isAdmin) noHpCell.classList.add('hidden');

                const kenagarianCell = row.insertCell();
                kenagarianCell.textContent = siswa.kenagarian || '-';
                if (!isGuruKelas1 && !isAdmin) kenagarianCell.classList.add('hidden');

                const kecamatanCell = row.insertCell();
                kecamatanCell.textContent = siswa.kecamatan || '-';
                if (!isGuruKelas1 && !isAdmin) kecamatanCell.classList.add('hidden');

                const kabupatenCell = row.insertCell();
                kabupatenCell.textContent = siswa.kabupaten || '-';
                if (!isGuruKelas1 && !isAdmin) kabupatenCell.classList.add('hidden');

                const actionCell = row.insertCell();
                actionCell.classList.add('no-print');
                actionCell.innerHTML = `
                    <button class="btn-edit" onclick="editSiswa('${siswa.id}')"><i class="fas fa-edit"></i> Edit</button>
                    <button class="btn-danger" onclick="confirmDelete('siswa', '${siswa.id}')"><i class="fas fa-trash"></i> Hapus</button>
                `;
            });
            clearForm(formDataSiswa);
            // Re-set class for Guru
            const kelasSiswaInput = document.getElementById('kelas-siswa');
            if (kelasSiswaInput && currentRole !== 'Admin' && currentClass) {
                kelasSiswaInput.value = currentClass;
            }
        }

        formDataSiswa.addEventListener('submit', function(event) {
            event.preventDefault();
            const id = document.getElementById('siswa-id').value;

            // Safely get values for all fields, including nama-ayah and nama-ibu
            const namaAyahEl = document.getElementById('nama-ayah');
            const namaIbuEl = document.getElementById('nama-ibu');
            const pekerjaanAyahEl = document.getElementById('pekerjaan-ayah');
            const pekerjaanIbuEl = document.getElementById('pekerjaan-ibu');
            const pendidikanAyahEl = document.getElementById('pendidikan-ayah');
            const pendidikanIbuEl = document.getElementById('pendidikan-ibu');
            const noHpEl = document.getElementById('no-hp');
            const kenagarianEl = document.getElementById('kenagarian');
            const kecamatanEl = document.getElementById('kecamatan');
            const kabupatenEl = document.getElementById('kabupaten');

            const newSiswa = {
                namaSiswa: document.getElementById('nama-siswa').value,
                kelas: document.getElementById('kelas-siswa').value,
                nisnNis: document.getElementById('nisn-nis').value,
                tempatLahir: document.getElementById('tempat-lahir').value,
                tanggalLahir: document.getElementById('tanggal-lahir').value,
                jenisKelamin: document.getElementById('jenis-kelamin').value, 
                agama: document.getElementById('agama').value, 
                alamat: document.getElementById('alamat-siswa').value,
                namaAyah: namaAyahEl ? namaAyahEl.value : '', 
                namaIbu: namaIbuEl ? namaIbuEl.value : '',   
                pekerjaanAyah: pekerjaanAyahEl ? pekerjaanAyahEl.value : '',
                pekerjaanIbu: pekerjaanIbuEl ? pekerjaanIbuEl.value : '', 
                pendidikanAyah: pendidikanAyahEl ? pendidikanAyahEl.value : '',
                pendidikanIbu: pendidikanIbuEl ? pendidikanIbuEl.value : '',
                noHp: noHpEl ? noHpEl.value : '',
                kenagarian: kenagarianEl ? kenagarianEl.value : '',
                kecamatan: kecamatanEl ? kecamatanEl.value : '',
                kabupaten: kabupatenEl ? kabupatenEl.value : ''
            };

            if (id) {
                const index = dataSiswa.findIndex(s => s.id === id);
                if (index !== -1) {
                    dataSiswa[index] = { ...dataSiswa[index], ...newSiswa };
                    showToast('Data Siswa berhasil diperbarui!');
                }
            } else {
                newSiswa.id = generateUniqueId();
                dataSiswa.push(newSiswa);
                showToast('Data Siswa berhasil ditambahkan!');
            }
            saveData('dataSiswa', dataSiswa);
            renderDataSiswaTable();
            // Update dropdowns that depend on siswa data
            // This is crucial for multi-select updates
            const filteredSiswa = getFilteredSiswa();
            populateSelect(ekskulSiswaSelect, filteredSiswa, 'id', 'namaSiswa');
            populateSelect(kokurSiswaSelect, filteredSiswa, 'id', 'namaSiswa');
            populateSelect(tpSiswaSelect, filteredSiswa, 'id', 'namaSiswa');
            populateSelect(nilaiSiswaSelect, filteredSiswa, 'id', 'namaSiswa');
            populateSelect(absensiSiswaSelect, filteredSiswa, 'id', 'namaSiswa');
            populateSelect(catatanSiswaSelect, filteredSiswa, 'id', 'namaSiswa');
            populateSelect(raporSiswaSelect, filteredSiswa, 'id', 'namaSiswa');
            populateSelect(promoteSiswaSelect, filteredSiswa, 'id', 'namaSiswa'); 
            populateSelect(identitasSiswaSelect, filteredSiswa, 'id', 'namaSiswa'); 
        });

        function editSiswa(id) {
            const siswa = dataSiswa.find(s => s.id === id);
            if (siswa) {
                document.getElementById('siswa-id').value = siswa.id;
                document.getElementById('nama-siswa').value = siswa.namaSiswa;
                document.getElementById('kelas-siswa').value = siswa.kelas;
                document.getElementById('nisn-nis').value = siswa.nisnNis;
                document.getElementById('tempat-lahir').value = siswa.tempatLahir;
                document.getElementById('tanggal-lahir').value = siswa.tanggalLahir;
                document.getElementById('jenis-kelamin').value = siswa.jenisKelamin || ''; 
                document.getElementById('agama').value = siswa.agama || ''; 
                document.getElementById('alamat-siswa').value = siswa.alamat;
                
                // Safely set values for all fields
                const namaAyahEl = document.getElementById('nama-ayah');
                if (namaAyahEl) namaAyahEl.value = siswa.namaAyah || '';
                const namaIbuEl = document.getElementById('nama-ibu');
                if (namaIbuEl) namaIbuEl.value = siswa.namaIbu || '';

                const pekerjaanAyahEl = document.getElementById('pekerjaan-ayah');
                if (pekerjaanAyahEl) pekerjaanAyahEl.value = siswa.pekerjaanAyah || '';
                const pekerjaanIbuEl = document.getElementById('pekerjaan-ibu');
                if (pekerjaanIbuEl) pekerjaanIbuEl.value = siswa.pekerjaanIbu || '';
                const pendidikanAyahEl = document.getElementById('pendidikan-ayah');
                if (pendidikanAyahEl) pendidikanAyahEl.value = siswa.pendidikanAyah || '';
                const pendidikanIbuEl = document.getElementById('pendidikan-ibu');
                if (pendidikanIbuEl) pendidikanIbuEl.value = siswa.pendidikanIbu || '';
                const noHpEl = document.getElementById('no-hp');
                if (noHpEl) noHpEl.value = siswa.noHp || '';
                const kenagarianEl = document.getElementById('kenagarian');
                if (kenagarianEl) kenagarianEl.value = siswa.kenagarian || '';
                const kecamatanEl = document.getElementById('kecamatan');
                if (kecamatanEl) kecamatanEl.value = siswa.kecamatan || '';
                const kabupatenEl = document.getElementById('kabupaten');
                if (kabupatenEl) kabupatenEl.value = siswa.kabupaten || '';

                showToast('Form Siswa siap diedit.');
            }
        }

        // Mata Pelajaran
        function renderMataPelajaranTable() {
            tableMataPelajaran.innerHTML = '';
            const isAdmin = currentRole === 'Admin';
            const isGuru = currentRole && currentRole.startsWith('Guru Kelas');

            dataMapel.forEach(mapel => {
                const row = tableMataPelajaran.insertRow();
                row.insertCell().textContent = mapel.namaMapel;
                const actionCell = row.insertCell();
                actionCell.classList.add('no-print');
                
                // Guru can now edit/delete mapel
                if (isAdmin || isGuru) {
                    actionCell.innerHTML = `
                        <button class="btn-edit" onclick="editMapel('${mapel.id}')"><i class="fas fa-edit"></i> Edit</button>
                        <button class="btn-danger" onclick="confirmDelete('mapel', '${mapel.id}')"><i class="fas fa-trash"></i> Hapus</button>
                    `;
                } else {
                    actionCell.textContent = '-';
                }
            });
            clearForm(formMataPelajaran);
        }

        formMataPelajaran.addEventListener('submit', function(event) {
            event.preventDefault();
            const isAdmin = currentRole === 'Admin';
            const isGuru = currentRole && currentRole.startsWith('Guru Kelas');

            if (!isAdmin && !isGuru) {
                showToast('Anda tidak memiliki izin untuk mengubah data Mata Pelajaran.', true);
                return;
            }
            const id = document.getElementById('mapel-id').value;
            const newMapel = {
                namaMapel: document.getElementById('nama-mapel').value
            };

            if (id) {
                const index = dataMapel.findIndex(m => m.id === id);
                if (index !== -1) {
                    dataMapel[index] = { ...dataMapel[index], ...newMapel };
                    showToast('Data Mata Pelajaran berhasil diperbarui!');
                }
            } else {
                newMapel.id = generateUniqueId();
                dataMapel.push(newMapel);
                showToast('Data Mata Pelajaran berhasil ditambahkan!');
            }
            saveData('dataMapel', dataMapel);
            renderMataPelajaranTable();
            // Update dropdowns that depend on mapel data
            populateSelect(tpMapelSelect, dataMapel, 'id', 'namaMapel');
            populateSelect(nilaiMapelSelect, dataMapel, 'id', 'namaMapel');
        });

        function editMapel(id) {
            const isAdmin = currentRole === 'Admin';
            const isGuru = currentRole && currentRole.startsWith('Guru Kelas');

            if (!isAdmin && !isGuru) return;
            
            const mapel = dataMapel.find(m => m.id === id);
            if (mapel) {
                document.getElementById('mapel-id').value = mapel.id;
                document.getElementById('nama-mapel').value = mapel.namaMapel;
                showToast('Form Mata Pelajaran siap diedit.');
            }
        }

        // Ekstrakurikuler
        function renderEkstrakurikulerTable() {
            tableEkstrakurikuler.innerHTML = '';
            const filteredEkskul = dataEkskul.filter(e => {
                const siswa = dataSiswa.find(s => s.id === e.siswaId);
                // Filter by class only if the student exists and user is a Guru
                return siswa && (currentRole === 'Admin' || siswa.kelas === currentClass);
            });
            filteredEkskul.forEach(ekskul => {
                const siswa = dataSiswa.find(s => s.id === ekskul.siswaId);
                const row = tableEkstrakurikuler.insertRow();
                row.insertCell().textContent = siswa ? siswa.namaSiswa : 'N/A';
                row.insertCell().textContent = ekskul.namaEkskul;
                row.insertCell().textContent = ekskul.keterangan;
                const actionCell = row.insertCell();
                actionCell.classList.add('no-print');
                actionCell.innerHTML = `
                    <button class="btn-edit" onclick="editEkskul('${ekskul.id}')"><i class="fas fa-edit"></i> Edit</button>
                    <button class="btn-danger" onclick="confirmDelete('ekskul', '${ekskul.id}')"><i class="fas fa-trash"></i> Hapus</button>
                `;
            });
            clearForm(formEkstrakurikuler);
            populateSelect(ekskulSiswaSelect, getFilteredSiswa(), 'id', 'namaSiswa');
        }

        formEkstrakurikuler.addEventListener('submit', function(event) {
            event.preventDefault();
            const id = document.getElementById('ekskul-id').value;
            const siswaId = ekskulSiswaSelect.value;
            
            // Check if the selected student belongs to the current guru's class
            const siswa = dataSiswa.find(s => s.id === siswaId);
            if (!siswa || (!currentRole.includes('Admin') && siswa.kelas !== currentClass)) {
                showToast('Siswa yang dipilih tidak sesuai dengan kelas Anda.', true);
                return;
            }

            const newEkskul = {
                siswaId: siswaId,
                namaEkskul: document.getElementById('nama-ekskul').value,
                keterangan: document.getElementById('keterangan-ekskul').value
            };

            if (id) {
                const index = dataEkskul.findIndex(e => e.id === id);
                if (index !== -1) {
                    dataEkskul[index] = { ...dataEkskul[index], ...newEkskul };
                    showToast('Data Ekstrakurikuler berhasil diperbarui!');
                }
            } else {
                newEkskul.id = generateUniqueId();
                dataEkskul.push(newEkskul);
                showToast('Data Ekstrakurikuler berhasil ditambahkan!');
            }
            saveData('dataEkskul', dataEkskul);
            renderEkstrakurikulerTable();
        });

        function editEkskul(id) {
            const ekskul = dataEkskul.find(e => e.id === id);
            if (ekskul) {
                document.getElementById('ekskul-id').value = ekskul.id;
                populateSelect(ekskulSiswaSelect, getFilteredSiswa(), 'id', 'namaSiswa', ekskul.siswaId);
                document.getElementById('nama-ekskul').value = ekskul.namaEkskul;
                document.getElementById('keterangan-ekskul').value = ekskul.keterangan;
                showToast('Form Ekstrakurikuler siap diedit.');
            }
        }

        // Kokurikuler
        function renderKokurikulerTable() {
            tableKokurikuler.innerHTML = '';
            const filteredKokur = dataKokur.filter(k => {
                const siswa = dataSiswa.find(s => s.id === k.siswaId);
                return siswa && (currentRole === 'Admin' || siswa.kelas === currentClass);
            });
            filteredKokur.forEach(kokur => {
                const siswa = dataSiswa.find(s => s.id === kokur.siswaId);
                const row = tableKokurikuler.insertRow();
                row.insertCell().textContent = siswa ? siswa.namaSiswa : 'N/A';
                row.insertCell().textContent = kokur.namaKokur;
                const actionCell = row.insertCell();
                actionCell.classList.add('no-print');
                actionCell.innerHTML = `
                    <button class="btn-edit" onclick="editKokur('${kokur.id}')"><i class="fas fa-edit"></i> Edit</button>
                    <button class="btn-danger" onclick="confirmDelete('kokur', '${kokur.id}')"><i class="fas fa-trash"></i> Hapus</button>
                `;
            });
            clearForm(formKokurikuler);
            populateSelect(kokurSiswaSelect, getFilteredSiswa(), 'id', 'namaSiswa');
        }

        formKokurikuler.addEventListener('submit', function(event) {
            event.preventDefault();
            const id = document.getElementById('kokur-id').value;
            const siswaId = kokurSiswaSelect.value;
            
            // Check if the selected student belongs to the current guru's class
            const siswa = dataSiswa.find(s => s.id === siswaId);
            if (!siswa || (!currentRole.includes('Admin') && siswa.kelas !== currentClass)) {
                showToast('Siswa yang dipilih tidak sesuai dengan kelas Anda.', true);
                return;
            }

            const newKokur = {
                siswaId: siswaId,
                namaKokur: document.getElementById('nama-kokur').value
            };

            if (id) {
                const index = dataKokur.findIndex(k => k.id === id);
                if (index !== -1) {
                    dataKokur[index] = { ...dataKokur[index], ...newKokur };
                    showToast('Data Kokurikuler berhasil diperbarui!');
                }
            } else {
                newKokur.id = generateUniqueId();
                dataKokur.push(newKokur);
                showToast('Data Kokurikuler berhasil ditambahkan!');
            }
            saveData('dataKokur', dataKokur);
            renderKokurikulerTable();
        });

        function editKokur(id) {
            const kokur = dataKokur.find(k => k.id === id);
            if (kokur) {
                document.getElementById('kokur-id').value = kokur.id;
                populateSelect(kokurSiswaSelect, getFilteredSiswa(), 'id', 'namaSiswa', kokur.siswaId);
                document.getElementById('nama-kokur').value = kokur.namaKokur;
                showToast('Form Kokurikuler siap diedit.');
            }
        }

        // Tujuan Pembelajaran
        function renderTujuanPembelajaranTable() {
            tableTujuanPembelajaran.innerHTML = '';
            const filteredTP = dataTujuanPembelajaran.filter(tp => {
                const siswa = dataSiswa.find(s => s.id === tp.siswaId);
                return siswa && (currentRole === 'Admin' || siswa.kelas === currentClass);
            });
            filteredTP.forEach(tp => {
                const siswa = dataSiswa.find(s => s.id === tp.siswaId);
                const mapel = dataMapel.find(m => m.id === tp.mapelId);
                const row = tableTujuanPembelajaran.insertRow();
                row.insertCell().textContent = siswa ? siswa.namaSiswa : 'N/A';
                row.insertCell().textContent = mapel ? mapel.namaMapel : 'N/A';
                row.insertCell().textContent = tp.tujuanPembelajaranText;
                const actionCell = row.insertCell();
                actionCell.classList.add('no-print');
                actionCell.innerHTML = `
                    <button class="btn-edit" onclick="editTujuanPembelajaran('${tp.id}')"><i class="fas fa-edit"></i> Edit</button>
                    <button class="btn-danger" onclick="confirmDelete('tujuanPembelajaran', '${tp.id}')"><i class="fas fa-trash"></i> Hapus</button>
                `;
            });
            clearForm(formTujuanPembelajaran);
            populateSelect(tpSiswaSelect, getFilteredSiswa(), 'id', 'namaSiswa');
            populateSelect(tpMapelSelect, dataMapel, 'id', 'namaMapel');
        }

        formTujuanPembelajaran.addEventListener('submit', function(event) {
            event.preventDefault();
            const id = document.getElementById('tp-id').value;
            const siswaId = tpSiswaSelect.value;
            
            // Check if the selected student belongs to the current guru's class
            const siswa = dataSiswa.find(s => s.id === siswaId);
            if (!siswa || (!currentRole.includes('Admin') && siswa.kelas !== currentClass)) {
                showToast('Siswa yang dipilih tidak sesuai dengan kelas Anda.', true);
                return;
            }

            const newTP = {
                siswaId: siswaId,
                mapelId: tpMapelSelect.value,
                tujuanPembelajaranText: document.getElementById('tujuan-pembelajaran-text').value
            };

            if (id) {
                const index = dataTujuanPembelajaran.findIndex(t => t.id === id);
                if (index !== -1) {
                    dataTujuanPembelajaran[index] = { ...dataTujuanPembelajaran[index], ...newTP };
                    showToast('Data Tujuan Pembelajaran berhasil diperbarui!');
                }
            } else {
                newTP.id = generateUniqueId();
                dataTujuanPembelajaran.push(newTP);
                showToast('Data Tujuan Pembelajaran berhasil ditambahkan!');
            }
            saveData('dataTujuanPembelajaran', dataTujuanPembelajaran);
            renderTujuanPembelajaranTable();
        });

        function editTujuanPembelajaran(id) {
            const tp = dataTujuanPembelajaran.find(t => t.id === id);
            if (tp) {
                document.getElementById('tp-id').value = tp.id;
                populateSelect(tpSiswaSelect, getFilteredSiswa(), 'id', 'namaSiswa', tp.siswaId);
                populateSelect(tpMapelSelect, dataMapel, 'id', 'namaMapel', tp.mapelId);
                document.getElementById('tujuan-pembelajaran-text').value = tp.tujuanPembelajaranText;
                showToast('Form Tujuan Pembelajaran siap diedit.');
            }
        }

        // Input Nilai
        function renderInputNilaiTable() {
            tableInputNilai.innerHTML = '';
            const filteredNilai = dataNilai.filter(nilai => {
                const siswa = dataSiswa.find(s => s.id === nilai.siswaId);
                return siswa && (currentRole === 'Admin' || siswa.kelas === currentClass);
            });
            filteredNilai.forEach(nilai => {
                const siswa = dataSiswa.find(s => s.id === nilai.siswaId);
                const mapel = dataMapel.find(m => m.id === nilai.mapelId);
                const row = tableInputNilai.insertRow();
                row.insertCell().textContent = siswa ? siswa.namaSiswa : 'N/A';
                row.insertCell().textContent = mapel ? mapel.namaMapel : 'N/A';
                row.insertCell().textContent = nilai.nilaiAkhir;
                row.insertCell().textContent = nilai.capaianKompetensi.length > 50 ? nilai.capaianKompetensi.substring(0, 50) + '...' : nilai.capaianKompetensi;
                const actionCell = row.insertCell();
                actionCell.classList.add('no-print');
                actionCell.innerHTML = `
                    <button class="btn-edit" onclick="editNilai('${nilai.id}')"><i class="fas fa-edit"></i> Edit</button>
                    <button class="btn-danger" onclick="confirmDelete('nilai', '${nilai.id}')"><i class="fas fa-trash"></i> Hapus</button>
                `;
            });
            clearForm(formInputNilai);
            populateSelect(nilaiSiswaSelect, getFilteredSiswa(), 'id', 'namaSiswa');
            populateSelect(nilaiMapelSelect, dataMapel, 'id', 'namaMapel');
            capaianKompetensiTextarea.value = ''; // Clear textarea
        }

        // Auto-fill Capaian Kompetensi
        nilaiSiswaSelect.addEventListener('change', updateCapaianKompetensi);
        nilaiMapelSelect.addEventListener('change', updateCapaianKompetensi);

        function updateCapaianKompetensi() {
            const siswaId = nilaiSiswaSelect.value;
            const mapelId = nilaiMapelSelect.value;
            let capaianText = 'Tidak ada Tujuan Pembelajaran yang ditemukan.';

            if (siswaId && mapelId) {
                const tpRecords = dataTujuanPembelajaran.filter(tp =>
                    tp.siswaId === siswaId && tp.mapelId === mapelId
                );
                if (tpRecords.length > 0) {
                    capaianText = tpRecords.map(tp => tp.tujuanPembelajaranText).join('\n- ');
                    if (tpRecords.length > 0) {
                        capaianText = '- ' + capaianText.replace(/\n-/g, '\n-'); // Ensure bullet for every line
                    }
                }
            }
            capaianKompetensiTextarea.value = capaianText;
        }

        formInputNilai.addEventListener('submit', function(event) {
            event.preventDefault();
            const id = document.getElementById('nilai-id').value;
            const siswaId = nilaiSiswaSelect.value;
            
            // Check if the selected student belongs to the current guru's class
            const siswa = dataSiswa.find(s => s.id === siswaId);
            if (!siswa || (!currentRole.includes('Admin') && siswa.kelas !== currentClass)) {
                showToast('Siswa yang dipilih tidak sesuai dengan kelas Anda.', true);
                return;
            }

            const newNilai = {
                siswaId: siswaId,
                mapelId: nilaiMapelSelect.value,
                nilaiAkhir: document.getElementById('nilai-akhir').value,
                capaianKompetensi: capaianKompetensiTextarea.value // Get auto-filled value
            };

            if (id) {
                const index = dataNilai.findIndex(n => n.id === id);
                if (index !== -1) {
                    dataNilai[index] = { ...dataNilai[index], ...newNilai };
                    showToast('Data Nilai berhasil diperbarui!');
                }
            } else {
                newNilai.id = generateUniqueId();
                dataNilai.push(newNilai);
                showToast('Data Nilai berhasil ditambahkan!');
            }
            saveData('dataNilai', dataNilai);
            renderInputNilaiTable();
        });

        function editNilai(id) {
            const nilai = dataNilai.find(n => n.id === id);
            if (nilai) {
                document.getElementById('nilai-id').value = nilai.id;
                populateSelect(nilaiSiswaSelect, getFilteredSiswa(), 'id', 'namaSiswa', nilai.siswaId);
                populateSelect(nilaiMapelSelect, dataMapel, 'id', 'namaMapel', nilai.mapelId);
                document.getElementById('nilai-akhir').value = nilai.nilaiAkhir;
                // Manually set capaian kompetensi for edit, it might be different if TP changed
                capaianKompetensiTextarea.value = nilai.capaianKompetensi;
                showToast('Form Nilai siap diedit.');
            }
        }

        // Ketidakhadiran
        function renderKetidakhadiranTable() {
            tableKetidakhadiran.innerHTML = '';
            const filteredAbsensi = dataKetidakhadiran.filter(a => {
                const siswa = dataSiswa.find(s => s.id === a.siswaId);
                return siswa && (currentRole === 'Admin' || siswa.kelas === currentClass);
            });
            filteredAbsensi.forEach(absensi => {
                const siswa = dataSiswa.find(s => s.id === absensi.siswaId);
                const row = tableKetidakhadiran.insertRow();
                row.insertCell().textContent = siswa ? siswa.namaSiswa : 'N/A';
                row.insertCell().textContent = absensi.jenisAbsensi;
                row.insertCell().textContent = absensi.jumlahHari;
                const actionCell = row.insertCell();
                actionCell.classList.add('no-print');
                actionCell.innerHTML = `
                    <button class="btn-edit" onclick="editKetidakhadiran('${absensi.id}')"><i class="fas fa-edit"></i> Edit</button>
                    <button class="btn-danger" onclick="confirmDelete('ketidakhadiran', '${absensi.id}')"><i class="fas fa-trash"></i> Hapus</button>
                `;
            });
            clearForm(formKetidakhadiran);
            populateSelect(absensiSiswaSelect, getFilteredSiswa(), 'id', 'namaSiswa');
        }

        formKetidakhadiran.addEventListener('submit', function(event) {
            event.preventDefault();
            const id = document.getElementById('absensi-id').value;
            const siswaId = absensiSiswaSelect.value;
            
            // Check if the selected student belongs to the current guru's class
            const siswa = dataSiswa.find(s => s.id === siswaId);
            if (!siswa || (!currentRole.includes('Admin') && siswa.kelas !== currentClass)) {
                showToast('Siswa yang dipilih tidak sesuai dengan kelas Anda.', true);
                return;
            }

            const newAbsensi = {
                siswaId: siswaId,
                jenisAbsensi: document.getElementById('jenis-absensi').value,
                jumlahHari: document.getElementById('jumlah-absensi').value
            };

            if (id) {
                const index = dataKetidakhadiran.findIndex(a => a.id === id);
                if (index !== -1) {
                    dataKetidakhadiran[index] = { ...dataKetidakhadiran[index], ...newAbsensi };
                    showToast('Data Ketidakhadiran berhasil diperbarui!');
                }
            } else {
                // Check if an absensi record of this type already exists for this student
                const existingAbsensi = dataKetidakhadiran.find(a => 
                    a.siswaId === siswaId && 
                    a.jenisAbsensi === newAbsensi.jenisAbsensi
                );
                
                if (existingAbsensi) {
                    // Update existing record instead of adding a new one
                    existingAbsensi.jumlahHari = newAbsensi.jumlahHari;
                    showToast('Data Ketidakhadiran berhasil diperbarui!');
                } else {
                    newAbsensi.id = generateUniqueId();
                    dataKetidakhadiran.push(newAbsensi);
                    showToast('Data Ketidakhadiran berhasil ditambahkan!');
                }
            }
            saveData('dataKetidakhadiran', dataKetidakhadiran);
            renderKetidakhadiranTable();
        });

        function editKetidakhadiran(id) {
            const absensi = dataKetidakhadiran.find(a => a.id === id);
            if (absensi) {
                document.getElementById('absensi-id').value = absensi.id;
                populateSelect(absensiSiswaSelect, getFilteredSiswa(), 'id', 'namaSiswa', absensi.siswaId);
                document.getElementById('jenis-absensi').value = absensi.jenisAbsensi;
                document.getElementById('jumlah-absensi').value = absensi.jumlahHari;
                showToast('Form Ketidakhadiran siap diedit.');
            }
        }

        // Catatan Wali Kelas
        function renderCatatanWalasTable() {
            tableCatatanWalas.innerHTML = '';
            const filteredCatatan = dataCatatanWalas.filter(c => {
                const siswa = dataSiswa.find(s => s.id === c.siswaId);
                return siswa && (currentRole === 'Admin' || siswa.kelas === currentClass);
            });
            filteredCatatan.forEach(catatan => {
                const siswa = dataSiswa.find(s => s.id === catatan.siswaId);
                const row = tableCatatanWalas.insertRow();
                row.insertCell().textContent = siswa ? siswa.namaSiswa : 'N/A';
                row.insertCell().textContent = catatan.catatanText.length > 50 ? catatan.catatanText.substring(0, 50) + '...' : catatan.catatanText;
                const actionCell = row.insertCell();
                actionCell.classList.add('no-print');
                actionCell.innerHTML = `
                    <button class="btn-edit" onclick="editCatatanWalas('${catatan.id}')"><i class="fas fa-edit"></i> Edit</button>
                    <button class="btn-danger" onclick="confirmDelete('catatanWalas', '${catatan.id}')"><i class="fas fa-trash"></i> Hapus</button>
                `;
            });
            clearForm(formCatatanWalas);
            populateSelect(catatanSiswaSelect, getFilteredSiswa(), 'id', 'namaSiswa');
        }

        formCatatanWalas.addEventListener('submit', function(event) {
            event.preventDefault();
            const id = document.getElementById('catatan-id').value;
            const siswaId = catatanSiswaSelect.value;
            
            // Check if the selected student belongs to the current guru's class
            const siswa = dataSiswa.find(s => s.id === siswaId);
            if (!siswa || (!currentRole.includes('Admin') && siswa.kelas !== currentClass)) {
                showToast('Siswa yang dipilih tidak sesuai dengan kelas Anda.', true);
                return;
            }
            
            const newCatatan = {
                siswaId: siswaId,
                catatanText: document.getElementById('catatan-text').value

            };

            if (id) {
                const index = dataCatatanWalas.findIndex(c => c.id === id);
                if (index !== -1) {
                    dataCatatanWalas[index] = { ...dataCatatanWalas[index], ...newCatatan };
                    showToast('Data Catatan Wali Kelas berhasil diperbarui!');
                }
            } else {
                // Check if a catatan already exists for this student, if so, update it
                const existingCatatan = dataCatatanWalas.find(c => c.siswaId === siswaId);
                if (existingCatatan) {
                    existingCatatan.catatanText = newCatatan.catatanText;
                    showToast('Data Catatan Wali Kelas berhasil diperbarui!');
                } else {
                    newCatatan.id = generateUniqueId();
                    dataCatatanWalas.push(newCatatan);
                    showToast('Data Catatan Wali Kelas berhasil ditambahkan!');
                }
            }
            saveData('dataCatatanWalas', dataCatatanWalas);
            renderCatatanWalasTable();
        });

        function editCatatanWalas(id) {
            const catatan = dataCatatanWalas.find(c => c.id === id);
            if (catatan) {
                document.getElementById('catatan-id').value = catatan.id;
                populateSelect(catatanSiswaSelect, getFilteredSiswa(), 'id', 'namaSiswa', catatan.siswaId);
                document.getElementById('catatan-text').value = catatan.catatanText;
                showToast('Form Catatan Wali Kelas siap diedit.');
            }
        }

        // Manajemen Pengguna
        function renderManajemenPenggunaTable() {
            tableManajemenPengguna.innerHTML = '';
            dataUsers.forEach(user => {
                const row = tableManajemenPengguna.insertRow();
                row.insertCell().textContent = user.username;
                row.insertCell().textContent = user.role;
                const actionCell = row.insertCell();
                actionCell.classList.add('no-print');
                // Prevent deleting the currently logged-in Admin or the last Admin
                const isCurrentUser = currentUser && user.id === currentUser.id;
                const isAdmin = user.role === 'Admin';
                const AdminCount = dataUsers.filter(u => u.role === 'Admin').length;
                const disableDelete = (isCurrentUser && isAdmin) || (isAdmin && AdminCount === 1);

                actionCell.innerHTML = `
                    <button class="btn-edit" onclick="editUser('${user.id}')"><i class="fas fa-edit"></i> Edit</button>
                    <button class="btn-danger ${disableDelete ? 'opacity-50 cursor-not-allowed' : ''}" ${disableDelete ? 'disabled' : ''} onclick="confirmDelete('user', '${user.id}')"><i class="fas fa-trash"></i> Hapus</button>
                `;
            });
            clearForm(formManajemenPengguna);
        }

        formManajemenPengguna.addEventListener('submit', function(event) {
            event.preventDefault();
            const id = document.getElementById('user-id').value;
            
            if (currentRole !== 'Admin') {
                showToast('Hanya Admin yang dapat mengelola Pengguna.', true);
                return;
            }

            const newUserData = {
                username: document.getElementById('new-username').value,
                password: document.getElementById('new-password').value,
                role: document.getElementById('new-role').value
            };

            if (id) {
                const index = dataUsers.findIndex(u => u.id === id);
                if (index !== -1) {
                    dataUsers[index] = { ...dataUsers[index], ...newUserData };
                    showToast('Data Pengguna berhasil diperbarui!');
                }
            } else {
                // Check for duplicate username
                const isDuplicate = dataUsers.some(u => u.username === newUserData.username);
                if (isDuplicate) {
                    showToast('Username sudah digunakan. Harap gunakan username lain.', true);
                    return;
                }
                newUserData.id = generateUniqueId();
                dataUsers.push(newUserData);
                showToast('Data Pengguna berhasil ditambahkan!');
            }
            saveData('dataUsers', dataUsers);
            renderManajemenPenggunaTable();
        });

        function editUser(id) {
            if (currentRole !== 'Admin') return;
            const user = dataUsers.find(u => u.id === id);
            if (user) {
                document.getElementById('user-id').value = user.id;
                document.getElementById('new-username').value = user.username;
                document.getElementById('new-password').value = user.password;
                document.getElementById('new-role').value = user.role;
                showToast('Form Pengguna siap diedit.');
            }
        }

        // --- Delete Confirmation Modal ---
        let deleteTargetType = null;
        let deleteTargetId = null;

        function confirmDelete(type, id) {
            if (type === 'user') {
                const userToDelete = dataUsers.find(u => u.id === id);
                const isAdmin = userToDelete && userToDelete.role === 'Admin';
                const AdminCount = dataUsers.filter(u => u.role === 'Admin').length;
                if (isAdmin && AdminCount === 1) {
                    showToast('Tidak bisa menghapus Admin terakhir!', true);
                    return;
                }
                if (currentUser && currentUser.id === id) {
                    showToast('Anda tidak dapat menghapus akun Anda sendiri!', true);
                    return;
                }
            }
            deleteTargetType = type;
            deleteTargetId = id;
            modalMessage.textContent = `Apakah Anda yakin ingin menghapus data ${type} ini?`;
            confirmationModal.style.display = 'flex';
        }

        confirmDeleteBtn.addEventListener('click', function() {
            performDelete(deleteTargetType, deleteTargetId);
            confirmationModal.style.display = 'none';
            deleteTargetType = null;
            deleteTargetId = null;
        });

        cancelDeleteBtn.addEventListener('click', function() {
            confirmationModal.style.display = 'none';
            deleteTargetType = null;
            deleteTargetId = null;
        });

        closeModalBtn.addEventListener('click', function() {
            confirmationModal.style.display = 'none';
            deleteTargetType = null;
            deleteTargetId = null;
        });

        function performDelete(type, id) {
            let deleted = false;
            switch (type) {
                case 'walas':
                    if (currentRole !== 'Admin') {
                        showToast('Hanya Admin yang dapat menghapus data Wali Kelas.', true);
                        return;
                    }
                    dataWalas = dataWalas.filter(w => w.id !== id);
                    saveData('dataWalas', dataWalas);
                    renderDataWalasTable();
                    deleted = true;
                    break;
                case 'siswa':
                    dataSiswa = dataSiswa.filter(s => s.id !== id);
                    saveData('dataSiswa', dataSiswa);
                    renderDataSiswaTable();
                    // Also delete related records
                    dataEkskul = dataEkskul.filter(e => e.siswaId !== id);
                    saveData('dataEkskul', dataEkskul);
                    dataKokur = dataKokur.filter(k => k.siswaId !== id);
                    saveData('dataKokur', dataKokur);
                    dataTujuanPembelajaran = dataTujuanPembelajaran.filter(tp => tp.siswaId !== id);
                    saveData('dataTujuanPembelajaran', dataTujuanPembelajaran);
                    dataNilai = dataNilai.filter(n => n.siswaId !== id);
                    saveData('dataNilai', dataNilai);
                    dataKetidakhadiran = dataKetidakhadiran.filter(a => a.siswaId !== id);
                    saveData('dataKetidakhadiran', dataKetidakhadiran);
                    dataCatatanWalas = dataCatatanWalas.filter(c => c.siswaId !== id);
                    saveData('dataCatatanWalas', dataCatatanWalas);
                    deleted = true;
                    // Re-populate all student-dependent selects
                    const filteredSiswa = getFilteredSiswa();
                    populateSelect(ekskulSiswaSelect, filteredSiswa, 'id', 'namaSiswa');
                    populateSelect(kokurSiswaSelect, filteredSiswa, 'id', 'namaSiswa');
                    populateSelect(tpSiswaSelect, filteredSiswa, 'id', 'namaSiswa');
                    populateSelect(nilaiSiswaSelect, filteredSiswa, 'id', 'namaSiswa');
                    populateSelect(absensiSiswaSelect, filteredSiswa, 'id', 'namaSiswa');
                    populateSelect(catatanSiswaSelect, filteredSiswa, 'id', 'namaSiswa');
                    populateSelect(raporSiswaSelect, filteredSiswa, 'id', 'namaSiswa');
                    populateSelect(promoteSiswaSelect, filteredSiswa, 'id', 'namaSiswa'); 
                    populateSelect(identitasSiswaSelect, filteredSiswa, 'id', 'namaSiswa'); 
                    break;
                case 'mapel':
                    const isAdmin = currentRole === 'Admin';
                    const isGuru = currentRole && currentRole.startsWith('Guru Kelas');
                    if (!isAdmin && !isGuru) {
                         showToast('Anda tidak memiliki izin untuk menghapus data Mata Pelajaran.', true);
                         return;
                    }
                    dataMapel = dataMapel.filter(m => m.id !== id);
                    saveData('dataMapel', dataMapel);
                    renderMataPelajaranTable();
                    // Also delete related records
                    dataTujuanPembelajaran = dataTujuanPembelajaran.filter(tp => tp.mapelId !== id);
                    saveData('dataTujuanPembelajaran', dataTujuanPembelajaran);
                    dataNilai = dataNilai.filter(n => n.mapelId !== id);
                    saveData('dataNilai', dataNilai);
                    deleted = true;
                    // Re-populate mapel-dependent selects
                    populateSelect(tpMapelSelect, dataMapel, 'id', 'namaMapel');
                    populateSelect(nilaiMapelSelect, dataMapel, 'id', 'namaMapel');
                    break;
                case 'ekskul':
                    dataEkskul = dataEkskul.filter(e => e.id !== id);
                    saveData('dataEkskul', dataEkskul);
                    renderEkstrakurikulerTable();
                    deleted = true;
                    break;
                case 'kokur':
                    dataKokur = dataKokur.filter(k => k.id !== id);
                    saveData('dataKokur', dataKokur);
                    renderKokurikulerTable();
                    deleted = true;
                    break;
                case 'tujuanPembelajaran':
                    dataTujuanPembelajaran = dataTujuanPembelajaran.filter(tp => tp.id !== id);
                    saveData('dataTujuanPembelajaran', dataTujuanPembelajaran);
                    renderTujuanPembelajaranTable();
                    deleted = true;
                    break;
                case 'nilai':
                    dataNilai = dataNilai.filter(n => n.id !== id);
                    saveData('dataNilai', dataNilai);
                    renderInputNilaiTable();
                    deleted = true;
                    break;
                case 'ketidakhadiran':
                    dataKetidakhadiran = dataKetidakhadiran.filter(a => a.id !== id);
                    saveData('dataKetidakhadiran', dataKetidakhadiran);
                    renderKetidakhadiranTable();
                    deleted = true;
                    break;
                case 'catatanWalas':
                    dataCatatanWalas = dataCatatanWalas.filter(c => c.id !== id);
                    saveData('dataCatatanWalas', dataCatatanWalas);
                    renderCatatanWalasTable();
                    deleted = true;
                    break;
                case 'user':
                    dataUsers = dataUsers.filter(u => u.id !== id);
                    saveData('dataUsers', dataUsers);
                    renderManajemenPenggunaTable();
                    deleted = true;
                    break;
            }
            if (deleted) {
                showToast(`Data ${type} berhasil dihapus!`);
            }
        }

        // --- Kenaikan Kelas ---
        function checkPromotionEligibility() {
            if (dataSekolah.semester === '2') {
                promoteClassBtn.disabled = false;
                promoteSiswaSelect.disabled = false; // Enable select when eligible
                promotionStatus.classList.add('hidden');
            } else {
                promoteClassBtn.disabled = true;
                promoteSiswaSelect.disabled = true; // Disable select when not eligible
                promotionStatus.classList.remove('hidden');
            }
            promotionResults.classList.add('hidden'); // Hide results by default
            promotionList.innerHTML = '';
        }

        promoteClassBtn.addEventListener('click', function() {
            const selectedSiswaId = promoteSiswaSelect.value;
            if (!selectedSiswaId) {
                showToast('Pilih siswa yang akan diproses kenaikan kelasnya terlebih dahulu!', true);
                return;
            }

            const siswaToProcess = dataSiswa.find(s => s.id === selectedSiswaId);
            if (!siswaToProcess) {
                showToast('Siswa tidak ditemukan.', true);
                return;
            }

            promotionList.innerHTML = ''; // Clear previous results
            let promotionMessage = '';
            let currentClassNum = parseInt(siswaToProcess.kelas);
            let nextClass = '';

            // This logic determines the message shown on the UI, not the actual student data update.
            if (!isNaN(currentClassNum)) {
                if (currentClassNum >= 1 && currentClassNum <= 5) {
                    nextClass = (currentClassNum + 1).toString();
                    promotionMessage = `${siswaToProcess.namaSiswa} dari Kelas ${siswaToProcess.kelas} akan **Naik ke Kelas ${nextClass}** di rapor.`;
                } else if (currentClassNum === 6) {
                    nextClass = 'Lulus';
                    promotionMessage = `${siswaToProcess.namaSiswa} dari Kelas 6 akan **Lulus** di rapor.`;
                } else {
                    promotionMessage = `${siswaToProcess.namaSiswa} (Kelas ${siswaToProcess.kelas}) tidak dapat dipromosikan.`;
                }
            } else {
                promotionMessage = `${siswaToProcess.namaSiswa} memiliki data kelas tidak valid.`;
            }

            // Save the promotion status to localStorage for the report generation to use
            let promotionData = loadData('dataPromotion', {});
            promotionData[siswaToProcess.id] = nextClass; // Store the target class/status (e.g., '2', 'Lulus')
            saveData('dataPromotion', promotionData);
            
            showToast('Status Kenaikan Kelas berhasil diproses untuk Rapor.');
            promotionResults.classList.remove('hidden');
            const li = document.createElement('li');
            li.innerHTML = promotionMessage;
            promotionList.appendChild(li);
        });
        
        // --- Helper Function for Rank Calculation ---
        function calculateClassRanks(siswaList) {
            if (siswaList.length === 0 || dataMapel.length === 0) return [];

            const studentAverages = siswaList.map(siswa => {
                let totalNilai = 0;
                let countNilai = 0;

                dataMapel.forEach(mapel => {
                    const nilaiSiswaMapel = dataNilai.find(n => n.siswaId === siswa.id && n.mapelId === mapel.id);
                    // Use average of all available mapel scores for ranking calculation
                    const nilai = nilaiSiswaMapel ? parseInt(nilaiSiswaMapel.nilaiAkhir) : NaN;
                    if (!isNaN(nilai) && nilai !== '-') {
                        totalNilai += nilai;
                        countNilai++;
                    }
                });

                const average = countNilai > 0 ? totalNilai / countNilai : 0;
                return {
                    siswaId: siswa.id,
                    average: average,
                    rank: 0, // Placeholder
                };
            });

            // Sort by average (descending)
            studentAverages.sort((a, b) => b.average - a.average);

            // Assign rank (handle ties)
            let currentRank = 1;
            for (let i = 0; i < studentAverages.length; i++) {
                if (i > 0 && studentAverages[i].average < studentAverages[i - 1].average) {
                    currentRank = i + 1;
                }
                studentAverages[i].rank = currentRank;
            }

            return studentAverages;
        }


        // --- Cetak Leger Nilai ---
        printLegerBtn.addEventListener('click', function() {
            const printContent = generateLegerNilaiHtml();
            if (!printContent) {
                showToast('Tidak ada data untuk dicetak Leger Nilai.', true);
                return;
            }
            
            // Create and print the content in a new window
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Cetak Leger Nilai</title>');
            printWindow.document.write('<script src="https://cdn.tailwindcss.com"><\/script>');
            printWindow.document.write('<style>');
            printWindow.document.write(`
                /* Mengatur ukuran kertas Legal (F4) dan orientasi Landscape */
                @page { 
                    size: 21.59cm 35.56cm landscape; /* Legal: 21.59cm x 35.56cm, Landscape */
                    margin: 1cm; 
                }
                body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background-color: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                .no-print { display: none !important; }
                table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; font-size: 0.75rem; } /* Font size disesuaikan untuk Landscape */
                th, td { padding: 0.3rem; text-align: center; border: 1px solid #000; } /* Padding disesuaikan */
                th { background-color: #e0e7ff; font-weight: bold; color: #333; }
                /* MODIFIKASI CSS: Memastikan teks Mata Pelajaran tampil lengkap dan wrap */
                .mapel-header { white-space: normal; vertical-align: bottom; }
                /* END MODIFIKASI CSS */
                .text-center { text-align: center; }
                .mb-8 { margin-bottom: 2rem; }
                .mt-8 { margin-top: 2rem; }
                .text-right { text-align: right; }
                .font-bold { font-weight: bold; }
                .text-xl { font-size: 1.25rem; }
                .text-2xl { font-size: 1.5rem; }
                .p-4 { padding: 1rem; }
                /* Grid untuk tanda tangan di Leger */
                .signature-grid-leger { 
                    display: grid; 
                    grid-template-columns: 1fr 1fr; 
                    gap: 0; 
                    margin-top: 3rem; 
                    width: 100%;
                }
                .signature-grid-leger > div {
                    padding: 0 1rem;
                }
                .signature-grid-leger .text-left { text-align: left; }
                .signature-grid-leger .text-right { text-align: right; }
                .signature-grid-leger .font-bold { margin-top: 2.5rem; }
            `);
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(printContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        });
        
        // REMOVED: Function to handle PDF Download for Leger Nilai
        // downloadLegerPdfBtn.addEventListener('click', downloadLegerPdf);

        function downloadLegerPdf() {
            const element = document.getElementById('print-area-leger');
            
            // 1. Generate content if not already present
            if (!element.innerHTML || element.innerHTML.includes('Tidak ada data')) {
                generateLegerNilai();
                if (!element.innerHTML || element.innerHTML.includes('Tidak ada data')) {
                    showToast('Harap generate Leger Nilai terlebih dahulu, atau pastikan data tersedia.', true);
                    return;
                }
            }

            // 2. Show loading overlay
            pdfLoadingOverlay.style.display = 'flex';
            
            // 3. Configuration for Legal, Landscape, Narrow Margin (0.5 inch = 12.7 mm)
            const opt = {
                margin: 12.7 / 25.4, // Convert mm to inches for html2pdf
                filename: `Leger_Nilai_Kelas_${currentClass || 'All'}_${dataSekolah.tahunPelajaran || 'Unknown'}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 3, logging: false },
                jsPDF: { unit: 'in', format: 'legal', orientation: 'landscape' },
                pagebreak: { avoid: '.no-break' } 
            };
            
            // 4. Run html2pdf
            html2pdf().from(element).set(opt).save().then(() => {
                // 5. Hide loading overlay and show success message
                pdfLoadingOverlay.style.display = 'none';
                showToast('Leger Nilai berhasil diunduh sebagai PDF!');
            }).catch(error => {
                console.error('PDF generation failed for Leger:', error);
                pdfLoadingOverlay.style.display = 'none';
                showToast('Gagal membuat PDF Leger. Cek konsol untuk detail.', true);
            });
        }


        function generateLegerNilaiHtml() {
            const filteredSiswa = getFilteredSiswa();
            if (filteredSiswa.length === 0 || dataMapel.length === 0) {
                return null;
            }

            const semesterText = dataSekolah.semester === '1' ? 'Ganjil' : 'Genap';
            const tanggalRaporFormatted = dataSekolah.tanggalRapor ? new Date(dataSekolah.tanggalRapor).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }) : '-';

            let htmlContent = `
                <div class="p-4" style="width: 100%; overflow-x: auto;">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold">LEGER NILAI SISWA</h2>
                        <h3 class="text-xl font-semibold">${dataSekolah.namaSekolah || 'UPT SDN 22 Tanah Keras'}</h3>
                        <p>Kelas: ${currentClass || 'Semua Kelas'}</p>
                        <p>Tahun Pelajaran: ${dataSekolah.tahunPelajaran || '-'}, Semester: ${semesterText} (${dataSekolah.semester || '-'})</p>
                    </div>
                    <table class="w-full border border-black">
                        <thead>
                            <tr class="bg-gray-100">
                                <th rowspan="2" style="width: 3%; min-width: 25px;">No.</th>
                                <th rowspan="2" style="width: 15%; min-width: 120px;">Nama Siswa</th>
                                <th colspan="${dataMapel.length}">Nilai Mata Pelajaran</th>
                                <th rowspan="2" style="width: 7%; min-width: 60px;">Rata-rata</th>
                            </tr>
                            <tr class="bg-gray-100">
            `;

            dataMapel.forEach(mapel => {
                // MODIFIKASI: Menghapus pemotongan teks dan menambahkan kelas untuk wrapping
                // Menetapkan min-width yang lebih kecil dan menggunakan persentase sisa yang lebih besar
                htmlContent += `<th class="mapel-header" style="width: ${75 / dataMapel.length}%; min-width: 60px;">${mapel.namaMapel}</th>`; 
            });

            htmlContent += `
                            </tr>
                        </thead>
                        <tbody>
            `;

            filteredSiswa.sort((a, b) => a.namaSiswa.localeCompare(b.namaSiswa)); // Sort by name

            filteredSiswa.forEach((siswa, index) => {
                htmlContent += `<tr>
                    <td class="border">${index + 1}</td>
                    <td class="border text-left">${siswa.namaSiswa}</td>
                `;

                let totalNilai = 0;
                let countNilai = 0;

                dataMapel.forEach(mapel => {
                    const nilaiSiswaMapel = dataNilai.find(n => n.siswaId === siswa.id && n.mapelId === mapel.id);
                    const nilai = nilaiSiswaMapel ? parseInt(nilaiSiswaMapel.nilaiAkhir) : '-';
                    if (!isNaN(nilai) && nilai !== '-') {
                        totalNilai += nilai;
                        countNilai++;
                    }
                    htmlContent += `<td class="border">${nilai}</td>`;
                });

                const rataRata = countNilai > 0 ? (totalNilai / countNilai).toFixed(2) : '-';
                htmlContent += `<td class="border font-bold">${rataRata}</td>`;

                htmlContent += `</tr>`;
            });

            const walasForCurrentClass = dataWalas.find(w => w.kelas === currentClass);

            // Menggunakan kelas khusus untuk grid tanda tangan agar layout tetap rapi di Landscape
            htmlContent += `
                        </tbody>
                    </table>
                    <div class="signature-grid-leger">
                        <div class="text-left">
                            <p class="font-bold">Mengetahui,</p>
                            <p>Kepala Sekolah</p>
                            <br><br><br>
                            <p class="font-bold underline">${dataSekolah.namaKepala || 'Nama Kepala Sekolah'}</p>
                            <p>NIP. ${dataSekolah.nipKepala || '-'}</p>
                        </div>
                        <div class="text-right">
                            <p>Tanah Keras, ${tanggalRaporFormatted}</p>
                            <p>Wali Kelas</p>
                            <br><br><br>
                            <p class="font-bold underline">${walasForCurrentClass ? walasForCurrentClass.namaWalas : 'Nama Wali Kelas'}</p>
                            <p>NIP. ${walasForCurrentClass ? walasForCurrentClass.nipWalas || '-' : '-'}</p>
                        </div>
                    </div>
                </div>
            `;
            return htmlContent;
        }

        function generateLegerNilai() {
            printAreaLeger.innerHTML = generateLegerNilaiHtml() || '<p class="text-gray-600">Tidak ada data siswa atau mata pelajaran untuk membuat leger.</p>';
        }


        // --- Cetak Rapor ---
        generateRaporBtn.addEventListener('click', function() {
            const selectedSiswaId = raporSiswaSelect.value;
            if (!selectedSiswaId) {
                showToast('Pilih siswa terlebih dahulu!', true);
                printAreaRapor.innerHTML = '';
                printRaporBtn.classList.add('hidden');
                // downloadRaporPdfBtn.classList.add('hidden'); // REMOVED
                return;
            }
            // Clear area and generate single rapor
            printAreaRapor.innerHTML = '';
            generateRapor(selectedSiswaId);
            printRaporBtn.classList.remove('hidden');
            // downloadRaporPdfBtn.classList.remove('hidden'); // REMOVED
        });
        
        // New event listener for mass generation
        generateRaporMassalBtn.addEventListener('click', generateRaporMassal);

        function generateRaporMassal() {
            const filteredSiswa = getFilteredSiswa();
            if (filteredSiswa.length === 0) {
                showToast('Tidak ada siswa di kelas Anda untuk digenerate rapor.', true);
                printAreaRapor.innerHTML = '';
                printRaporBtn.classList.add('hidden');
                // downloadRaporPdfBtn.classList.add('hidden'); // REMOVED
                return;
            }

            printAreaRapor.innerHTML = ''; // Clear previous content
            let allRaporHtml = '';
            
            // Sort students by name for a clear print order
            filteredSiswa.sort((a, b) => a.namaSiswa.localeCompare(b.namaSiswa)); 

            filteredSiswa.forEach((siswa, index) => {
                // Generate rapor for each student
                const raporHtml = generateRapor(siswa.id, true); // Pass true for mass mode
                allRaporHtml += raporHtml;
                
                // Add page break after every rapor except the last one
                if (index < filteredSiswa.length - 1) {
                    allRaporHtml += `<div class="rapor-page-break no-print"></div>`;
                }
            });

            printAreaRapor.innerHTML = allRaporHtml;
            printRaporBtn.classList.remove('hidden');
            // downloadRaporPdfBtn.classList.remove('hidden'); // REMOVED
            showToast(`Berhasil generate ${filteredSiswa.length} rapor.`);
        }
        
        // REMOVED: Function to handle PDF Download for Rapor
        // downloadRaporPdfBtn.addEventListener('click', downloadRaporPdf);

        function downloadRaporPdf() {
            const element = document.getElementById('print-area-rapor');
            
            // 1. Check if content is generated
            if (!element.innerHTML || element.innerHTML.includes('siswa tidak ditemukan')) {
                showToast('Harap generate Rapor (tunggal atau massal) terlebih dahulu.', true);
                return;
            }
            
            // 2. Show loading overlay
            pdfLoadingOverlay.style.display = 'flex';

            // 3. Configuration for Legal, Portrait, Narrow Margin (0.5 inch = 12.7 mm)
            const opt = {
                margin: 12.7 / 25.4, // Convert mm to inches
                filename: `Rapor_Kelas_${currentClass || 'All'}_${dataSekolah.tahunPelajaran || 'Unknown'}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 3, logging: false },
                jsPDF: { unit: 'in', format: 'legal', orientation: 'portrait' },
                pagebreak: { before: '.rapor-page-break', after: '.no-break', mode: ['avoid-all', 'css'] } // Use custom page break class
            };
            
            // 4. Run html2pdf
            html2pdf().from(element).set(opt).save().then(() => {
                // 5. Hide loading overlay and show success message
                pdfLoadingOverlay.style.display = 'none';
                showToast('Rapor berhasil diunduh sebagai PDF!');
            }).catch(error => {
                console.error('PDF generation failed for Rapor:', error);
                pdfLoadingOverlay.style.display = 'none';
                showToast('Gagal membuat PDF Rapor. Cek konsol untuk detail.', true);
            });
        }


        printRaporBtn.addEventListener('click', function() {
            const printContent = printAreaRapor.innerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Cetak Rapor</title>');
            printWindow.document.write('<script src="https://cdn.tailwindcss.com"><\/script>');
            printWindow.document.write('<style>');
            printWindow.document.write(`
                @page { size: A4; margin: 1cm; }
                body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background-color: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                .no-print { display: none !important; }
                /* Styles for Rapor layout */
                table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
                th, td { padding: 0.5rem; text-align: left; border: 1px solid #000; font-size: 0.85rem; vertical-align: top; }
                th { background-color: #e0e7ff; font-weight: bold; color: #333; text-align: center; }
                /* Custom style for summary row */
                .summary-row td { background-color: #f0f4ff; font-weight: bold; text-align: center; }
                .summary-row td:first-child { text-align: left; }
                .header-table td { border: none; padding: 0.2rem 0; }
                .rapor-section { margin-bottom: 1.5rem; }
                .rapor-section h3 { font-size: 1rem; font-weight: bold; margin-bottom: 0.5rem; border-bottom: 1px solid #ccc; padding-bottom: 0.25rem; }
                /* Updated signature-grid: 3 equal columns, centered content */
                .signature-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-top: 3rem; }
                .signature-grid div { text-align: center; }
                /* Ensure Ortu is aligned left and Walas is aligned right (only in print) */
                .signature-grid .ortu-signature { text-align: left !important; } 
                .signature-grid .walas-signature { text-align: right !important; } 
                
                .signature-grid p { margin: 0.1rem 0; font-size: 0.9rem; }
                .signature-grid .font-bold { font-weight: bold; margin-top: 4rem; text-decoration: underline; }
                .signature-grid .date { margin-bottom: 0.5rem; }
                
                /* ADDED: New style for rapor header border */
                .rapor-header-border {
                    border-bottom: 3px solid #000; /* Garis tebal hitam */
                    padding-bottom: 0.5rem; /* Jarak antara teks dan garis */
                    margin-bottom: 1.5rem; /* Jarak antara header dan konten pertama */
                }
                
                /* Force page break for mass printing */
                .rapor-page-break {
                    page-break-before: always;
                    height: 1px; /* Remove visible dashed line on print */
                    border: none;
                }
            `);
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(printContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        });

        function generateRapor(siswaId, isMassal = false) {
            const siswa = dataSiswa.find(s => s.id === siswaId);
            if (!siswa) {
                // Return an error message if in massal mode, or set print area if in single mode
                const errorMessage = '<p class="text-red-500">Data siswa tidak ditemukan.</p>';
                if (isMassal) return errorMessage;
                printAreaRapor.innerHTML = errorMessage;
                return;
            }

            const promotionData = loadData('dataPromotion', {});
            const filteredSiswa = getFilteredSiswa();
            
            // Calculate Rank
            const classRanks = calculateClassRanks(filteredSiswa);
            const studentRankData = classRanks.find(r => r.siswaId === siswaId);
            const rankText = studentRankData ? `${studentRankData.rank} dari ${filteredSiswa.length}` : 'Belum Tersedia';

            const semesterText = dataSekolah.semester === '1' ? 'Ganjil' : 'Genap';
            const tanggalRaporFormatted = dataSekolah.tanggalRapor ? new Date(dataSekolah.tanggalRapor).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }) : '-';

            let raporKelasDisplay = siswa.kelas; // Default to current class
            let promotionStatusText = '-'; // Default status if not processed/Genap

            // Determine the promotion status based on saved data
            if (dataSekolah.semester === '2') {
                 const promotionResult = promotionData[siswa.id];
                 if (promotionResult === 'Lulus') {
                     raporKelasDisplay = 'Lulus';
                     promotionStatusText = 'Lulus';
                 } else if (promotionResult && !isNaN(parseInt(promotionResult))) {
                     raporKelasDisplay = promotionResult;
                     promotionStatusText = `Naik ke kelas ${promotionResult}`;
                 } else {
                     promotionStatusText = 'Tinggal kelas'; // If semester 2 but no successful promotion result saved
                 }
            }
            
            // Find the walas for the student's CURRENT class (as stored in dataSiswa)
            const walasForStudentClass = dataWalas.find(w => w.kelas === siswa.kelas);
            const walasName = walasForStudentClass ? walasForStudentClass.namaWalas : 'Nama Wali Kelas';
            const walasNip = walasForStudentClass ? walasForStudentClass.nipWalas : '-';

            // --- Calculation for Nilai Summary ---
            let totalNilai = 0;
            let countMapel = 0;
            const nilaiMapelRows = [];

            dataMapel.forEach((mapel) => {
                const nilai = dataNilai.find(n => n.siswaId === siswa.id && n.mapelId === mapel.id);
                const nilaiAkhir = nilai ? parseInt(nilai.nilaiAkhir) : '-';
                const capaianKompetensi = nilai ? nilai.capaianKompetensi : 'Data Capaian Kompetensi belum diinput.';
                
                if (!isNaN(parseInt(nilaiAkhir))) {
                    totalNilai += parseInt(nilaiAkhir);
                    countMapel++;
                }
                
                nilaiMapelRows.push(`
                    <tr>
                        <td class="border text-center">${nilaiMapelRows.length + 1}</td>
                        <td class="border">${mapel.namaMapel}</td>
                        <td class="border text-center">${nilaiAkhir}</td>
                        <td class="border whitespace-pre-wrap">${capaianKompetensi}</td>
                    </tr>
                `);
            });

            const rataRataNilai = countMapel > 0 ? (totalNilai / countMapel).toFixed(2) : '-';

            // --- End Calculation for Nilai Summary ---

            let raporHtml = `
                <div class="p-4">
                    <div class="text-center mb-6 rapor-header-border"> <!-- MODIFIKASI: Tambah class rapor-header-border -->
                        <h2 class="text-2xl font-bold">LAPORAN HASIL BELAJAR</h2>
                        <h3 class="text-xl font-semibold">${dataSekolah.namaSekolah || 'UPT SDN 22 TANAH KERAS'}</h3>
                        <p>Tahun Pelajaran: ${dataSekolah.tahunPelajaran || '-'}, Semester: ${semesterText} (${dataSekolah.semester || '-'})</p>
                    </div>

                    <table class="header-table w-full mb-6">
                        <tr>
                            <td style="width: 50%; padding-left: 0;"><strong>Nama Siswa:</strong> ${siswa.namaSiswa}</td>
                            <td style="width: 50%;"><strong>Nama Sekolah:</strong> ${dataSekolah.namaSekolah || '-'}</td>
                        </tr>
                        <tr>
                            <td style="padding-left: 0;"><strong>NISN/NIS:</strong> ${siswa.nisnNis}</td>
                            <td><strong>NPSN:</strong> ${dataSekolah.npsn || '-'}</td>
                        </tr>
                        <tr>
                            <td style="padding-left: 0;"><strong>Kelas:</strong> ${siswa.kelas}</td>
                            <td><strong>Alamat:</strong> ${dataSekolah.alamatSekolah || '-'}</td>
                        </tr>
                    </table>
                    
                    <!-- OLD POSITION of Peringkat Siswa was here (now removed) -->

                    <div class="rapor-section">
                        <h3>A. Nilai Mata Pelajaran</h3>
                        <table class="w-full border border-black">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th style="width: 5%;">No.</th>
                                    <th style="width: 30%;">Mata Pelajaran</th>
                                    <th style="width: 10%;">Nilai Akhir</th>
                                    <th style="width: 55%;">Capaian Kompetensi</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${nilaiMapelRows.join('')}
                            </tbody>
                            <tfoot>
                                <tr class="summary-row">
                                    <td colspan="2" style="text-align: right;">Jumlah Nilai:</td>
                                    <td class="border text-center">${totalNilai}</td>
                                    <td class="border text-center">Rata-rata: ${rataRataNilai}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <!-- NEW POSITION: Peringkat Siswa Section (DIPINDAHKAN KE SINI) -->
                    <div class="rapor-section">
                        <h3>Peringkat Siswa</h3>
                        <div class="border border-black p-4 rounded-lg text-center bg-green-50">
                            <p class="text-lg font-bold">Peringkat Kelas: ${rankText}</p>
                        </div>
                    </div>

                    <div class="rapor-section">
                        <h3>B. Ekstrakurikuler</h3>
                        <table class="w-full border border-black">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th style="width: 5%;">No.</th>
                                    <th style="width: 45%;">Ekstrakurikuler</th>
                                    <th style="width: 50%;">Keterangan</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
            const siswaEkskul = dataEkskul.filter(e => e.siswaId === siswa.id);
            if (siswaEkskul.length > 0) {
                siswaEkskul.forEach((ekskul, index) => {
                    raporHtml += `
                        <tr>
                            <td class="border text-center">${index + 1}</td>
                            <td class="border">${ekskul.namaEkskul}</td>
                            <td class="border">${ekskul.keterangan || '-'}</td>
                        </tr>
                    `;
                });
            } else {
                raporHtml += `<tr><td class="border text-center" colspan="3">Tidak ada data ekstrakurikuler.</td></tr>`;
            }
            raporHtml += `
                            </tbody>
                        </table>
                    </div>

                    <div class="rapor-section">
                        <h3>C. Kokurikuler</h3>
                        <table class="w-full border border-black">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th style="width: 5%;">No.</th>
                                    <th style="width: 95%;">Kokurikuler</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
            const siswaKokur = dataKokur.filter(k => k.siswaId === siswa.id);
            if (siswaKokur.length > 0) {
                siswaKokur.forEach((kokur, index) => {
                    raporHtml += `
                        <tr>
                            <td class="border text-center">${index + 1}</td>
                            <td class="border">${kokur.namaKokur}</td>
                        </tr>
                    `;
                });
            } else {
                raporHtml += `<tr><td class="border text-center" colspan="2">Tidak ada data kokurikuler.</td></tr>`;
            }
            raporHtml += `
                            </tbody>
                        </table>
                    </div>

                    <div class="rapor-section">
                        <h3>D. Ketidakhadiran</h3>
                        <table class="w-full border border-black" style="width: 50%;">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th style="width: 70%;">Jenis Absensi</th>
                                    <th style="width: 30%;">Jumlah Hari</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
            const getAbsensi = (type) => dataKetidakhadiran.find(a => a.siswaId === siswa.id && a.jenisAbsensi === type);
            const absensiSakit = getAbsensi('Sakit');
            const absensiIzin = getAbsensi('Izin');
            const absensiTK = getAbsensi('Tanpa Keterangan');

            raporHtml += `
                <tr><td class="border">Sakit</td><td class="border text-center">${absensiSakit ? absensiSakit.jumlahHari : 0} hari</td></tr>
                <tr><td class="border">Izin</td><td class="border text-center">${absensiIzin ? absensiIzin.jumlahHari : 0} hari</td></tr>
                <tr><td class="border">Tanpa Keterangan</td><td class="border text-center">${absensiTK ? absensiTK.jumlahHari : 0} hari</td></tr>
            `;
            raporHtml += `
                            </tbody>
                        </table>
                    </div>

                    <div class="rapor-section">
                        <h3>E. Catatan Wali Kelas</h3>
                        <div class="border border-black p-4 rounded-lg">
                            <p>${dataCatatanWalas.find(c => c.siswaId === siswa.id)?.catatanText || 'Tidak ada catatan.'}</p>
                        </div>
                    </div>
            `;

            // F. Kenaikan Kelas section, only for Genap semester
            if (dataSekolah.semester === '2') {
                raporHtml += `
                    <div class="rapor-section">
                        <h3>F. Keputusan Kenaikan Kelas</h3>
                        <div class="border border-black p-4 rounded-lg text-center bg-yellow-50">
                            <p class="text-lg font-bold">${promotionStatusText}</p>
                        </div>
                    </div>
                `;
            }
            
            // NEW SIGNATURE GRID (Left: Ortu, Center: Kepala Sekolah, Right: Wali Kelas)
            raporHtml += `
                <div class="signature-grid">
                    <div class="ortu-signature">
                        <p class="date text-center">Mengetahui,</p>
                        <p class="text-center">Orang Tua/Wali</p>
                        <p class="font-bold">${siswa.namaAyah || 'Nama Ayah'}</p>
                        <p>_________________________</p>
                    </div>
                    <div class="kepsek-signature">
                        <p class="date text-center">Mengetahui,</p>
                        <p class="text-center">Kepala Sekolah</p>
                        <p class="font-bold">${dataSekolah.namaKepala || 'Nama Kepala Sekolah'}</p>
                        <p>NIP. ${dataSekolah.nipKepala || '-'}</p>
                    </div>
                    <div class="walas-signature">
                        <p class="date">Tanah Keras, ${tanggalRaporFormatted}</p>
                        <p>Wali Kelas</p>
                        <p class="font-bold">${walasName}</p>
                        <p>NIP. ${walasNip}</p>
                    </div>
                </div>
            </div>
            `;

            // If not in massal mode, update the print area directly. Otherwise, return HTML string.
            if (!isMassal) {
                printAreaRapor.innerHTML = raporHtml;
            }
            return raporHtml;
        }

        // --- Cetak Identitas Siswa ---
        generateIdentitasBtn.addEventListener('click', function() {
            const selectedSiswaId = identitasSiswaSelect.value;
            if (!selectedSiswaId) {
                showToast('Pilih siswa terlebih dahulu!', true);
                printAreaIdentitas.innerHTML = '';
                printIdentitasBtn.classList.add('hidden');
                return;
            }
            generateIdentitas(selectedSiswaId);
            printIdentitasBtn.classList.remove('hidden');
        });

        printIdentitasBtn.addEventListener('click', function() {
            const printContent = printAreaIdentitas.innerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Cetak Identitas Siswa</title>');
            printWindow.document.write('<script src="https://cdn.tailwindcss.com"><\/script>');
            printWindow.document.write('<style>');
            printWindow.document.write(`
                /* Set size to Legal (approx F4 in dimensions) for longer vertical print */
                @page { size: 21.59cm 33.02cm; margin: 1cm; } 

                body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background-color: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                .identity-card-container {
                    width: 19cm; /* Card width for print */
                    max-width: 19cm;
                    margin: 0 auto;
                    padding: 10px;
                    border: 2px solid #000; /* Strong border for print */
                    background-color: white;
                    min-height: 400px;
                }
                .identity-card-header {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin-bottom: 20px;
                    text-align: center;
                    border-bottom: 2px solid #000;
                    padding-bottom: 10px;
                }
                .identity-card-header img {
                    width: 60px;
                    height: 60px;
                    margin-right: 15px;
                }
                .identity-card-header h2 {
                    font-size: 1.4rem;
                    font-weight: bold;
                    margin: 0;
                    color: #1a73e8; /* Blue accent */
                }
                .identity-card-header p {
                    font-size: 0.8rem;
                    margin: 0;
                }
                .identity-card-body {
                    display: block; /* FULL BLOCK */
                    gap: 0;
                }
                .identity-card-details-wrapper {
                    display: block; /* Ensures vertical stacking */
                    width: 100%;
                    order: 1; /* Details first */
                }
                .identity-card-details {
                    columns: 1 !important; /* Single column for details */
                    width: 100%;
                    order: 1;
                    margin-top: 10px;
                }
                .identity-card-details p {
                    margin-bottom: 5px;
                    font-size: 0.9rem;
                    line-height: 1.5;
                    break-inside: avoid;
                }
                .identity-card-details strong {
                    display: inline-block;
                    width: 180px; /* FIXED width for colon alignment */
                    text-align: left;
                    margin-right: 5px;
                }
                .identity-card-photo-wrapper {
                    width: 100%;
                    display: block; /* Occupy full width at the bottom of the body */
                    order: 2; /* Photo below the details */
                    margin-top: 20px;
                    text-align: center;
                }
                .identity-card-photo {
                    width: 120px;
                    height: 150px;
                    background-color: #f0f0f0;
                    border: 1px solid #ccc;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 0.7rem;
                    color: #666;
                    margin: 0 auto 5px auto;
                    border: 2px dashed #999;
                }
                .identity-card-footer {
                    display: flex;
                    justify-content: flex-end; /* Align Kepala Sekolah to the right */
                    align-items: flex-end;
                    margin-top: 10px;
                    padding-top: 10px;
                    border-top: none; /* No top border */
                }
                .identity-card-signature {
                    text-align: right;
                    width: 300px;
                }
                .identity-card-signature p {
                    font-size: 0.85rem;
                    text-align: right;
                }
                .identity-card-signature .font-bold {
                    font-weight: bold;
                    margin-top: 3rem;
                    text-decoration: underline;
                    text-align: right;
                }
                .identity-card-signature .date-line {
                    display: block;
                    margin-bottom: 0.5rem;
                }
                .no-print { display: none !important; }
            `);
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(printContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        });

        function generateIdentitas(siswaId) {
            printAreaIdentitas.innerHTML = '';
            const siswa = dataSiswa.find(s => s.id === siswaId);
            if (!siswa) {
                printAreaIdentitas.innerHTML = '<p class="text-red-500">Data siswa tidak ditemukan.</p>';
                return;
            }

            const tanggalRaporFormatted = dataSekolah.tanggalRapor ? new Date(dataSekolah.tanggalRapor).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }) : '-';

            // Function to format detail lines (key: value)
            const detailLine = (label, value) => {
                const displayValue = value || '-';
                // Use a fixed width for the strong tag to align colons (handled in CSS)
                return `<p><strong>${label}:</strong> ${displayValue}</p>`;
            };

            let identitasHtml = `
                <div class="identity-card-container">
                    <div class="identity-card-header">
                        <img src="https://iili.io/3b1SedN.png" alt="Logo Sekolah">
                        <div>
                            <h2>IDENTITAS SISWA</h2>
                            <p>${dataSekolah.namaSekolah || 'UPT SDN 22 Tanah Keras'}</p>
                            <p>${dataSekolah.alamatSekolah || 'Alamat Sekolah'}</p>
                        </div>
                    </div>
                    <div class="identity-card-body">
                        <div class="identity-card-details-wrapper">
                            <div class="identity-card-details">
                                ${detailLine('Nama Lengkap', siswa.namaSiswa)}
                                ${detailLine('NISN/NIS', siswa.nisnNis)}
                                ${detailLine('Kelas', siswa.kelas)}
                                ${detailLine('Tempat, Tgl Lahir', `${siswa.tempatLahir || '-'}, ${siswa.tanggalLahir || '-'}`)}
                                ${detailLine('Jenis Kelamin', siswa.jenisKelamin)}
                                ${detailLine('Agama', siswa.agama)}
                                ${detailLine('Alamat', siswa.alamat)}
                                ${detailLine('Nama Ayah', siswa.namaAyah)}
                                ${detailLine('Nama Ibu', siswa.namaIbu)}
                                ${detailLine('Pekerjaan Ayah', siswa.pekerjaanAyah)}
                                ${detailLine('Pendidikan Ayah', siswa.pendidikanAyah)}
                                ${detailLine('Pekerjaan Ibu', siswa.pekerjaanIbu)}
                                ${detailLine('Pendidikan Ibu', siswa.pendidikanIbu)}
                                ${detailLine('No. HP', siswa.noHp)}
                                ${detailLine('Kenagarian', siswa.kenagarian)}
                                ${detailLine('Kecamatan', siswa.kecamatan)}
                                ${detailLine('Kabupaten', siswa.kabupaten)}
                                ${detailLine('Email Sekolah', dataSekolah.email)}
                                ${detailLine('Website Sekolah', dataSekolah.website)}
                                ${detailLine('Tanggal Rapor', tanggalRaporFormatted)}
                            </div>
                            
                            <!-- Foto Siswa dipindahkan ke sini di dalam body -->
                            <div class="identity-card-photo-wrapper">
                                <div class="identity-card-photo">
                                    FOTO SISWA <br> (3x4)
                                </div>
                                <!-- Menghilangkan tulisan "Tanda Tangan Siswa" sesuai permintaan -->
                            </div>
                        </div>
                    </div>
                    <div class="identity-card-footer">
                        <div class="identity-card-signature">
                            <p class="date-line">Tanah Keras, ${tanggalRaporFormatted}</p>
                            <p>Mengetahui,</p>
                            <p>Kepala Sekolah</p>
                            <p class="font-bold">${dataSekolah.namaKepala || 'Nama Kepala Sekolah'}</p>
                            <p>NIP. ${dataSekolah.nipKepala || '-'}</p>
                        </div>
                    </div>
                </div>
            `;
            printAreaIdentitas.innerHTML = identitasHtml;
        }

        // --- Import Data Siswa from Excel ---
        importExcelBtn.addEventListener('click', handleExcelImport);

        function handleExcelImport() {
            const file = excelFileInput.files[0];
            if (!file) {
                showToast('Pilih file Excel terlebih dahulu!', true);
                return;
            }

            importStatusDiv.classList.remove('hidden');
            importStatusDiv.textContent = 'Memproses file...';
            importStatusDiv.classList.remove('text-red-500', 'text-green-600');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); // Get raw array of arrays
                    
                    if (json.length === 0) {
                        showToast('File Excel kosong.', true);
                        importStatusDiv.textContent = 'Gagal impor: File Excel kosong.';
                        importStatusDiv.classList.add('text-red-500');
                        return;
                    }

                    // Map headers to required fields (assuming header is the first row)
                    const rawHeaders = json[0];
                    const dataRows = json.slice(1);

                    const requiredHeaders = [
                        'Nama Siswa', 'Kelas', 'NISN/NIS', 'Tempat Lahir', 'Tanggal Lahir',
                        'Jenis Kelamin', 'Agama', 'Alamat', 'Nama Ayah', 'Nama Ibu',
                        'Pekerjaan Ayah', 'Pekerjaan Ibu', 'Pendidikan Ayah', 'Pendidikan Ibu',
                        'No. HP', 'Kenagarian', 'Kecamatan', 'Kabupaten'
                    ];

                    const headerMap = {};
                    requiredHeaders.forEach(reqHeader => {
                        const index = rawHeaders.findIndex(h => String(h).trim() === reqHeader);
                        if (index !== -1) {
                            headerMap[reqHeader] = index;
                        }
                    });

                    const missingHeaders = requiredHeaders.filter(header => headerMap[header] === undefined);

                    if (missingHeaders.length > 0) {
                        showToast(`Gagal impor: Kolom yang hilang di Excel: ${missingHeaders.join(', ')}. Pastikan nama kolom persis sama.`, true);
                        importStatusDiv.textContent = `Gagal impor: Kolom yang hilang di Excel: ${missingHeaders.join(', ')}.`;
                        importStatusDiv.classList.add('text-red-500');
                        return;
                    }


                    let importedCount = 0;
                    let skippedCount = 0;
                    let validationErrors = [];
                    
                    dataRows.forEach((row, index) => {
                        // Create a row object for easier access
                        const rowData = {};
                        requiredHeaders.forEach(header => {
                             rowData[header] = row[headerMap[header]] !== undefined ? String(row[headerMap[header]]) : '';
                        });
                        
                        // Basic validation: ensure essential fields are not empty
                        if (!rowData['Nama Siswa'].trim() || !rowData['Kelas'].trim() || !rowData['NISN/NIS'].trim()) {
                            skippedCount++;
                            validationErrors.push(`Baris ${index + 2} dilewati: Nama Siswa, Kelas, atau NISN/NIS kosong.`);
                            return;
                        }

                        // Check if a student with the same NISN/NIS already exists
                        const nisnNis = rowData['NISN/NIS'].trim();
                        const existingStudent = dataSiswa.find(s => s.nisnNis === nisnNis);
                        if (existingStudent) {
                            skippedCount++;
                            validationErrors.push(`Baris ${index + 2} dilewati: Siswa dengan NISN/NIS ${nisnNis} sudah ada.`);
                            return;
                        }

                        // Format date
                        let tanggalLahirFormatted = rowData['Tanggal Lahir'].trim();
                        if (tanggalLahirFormatted) {
                            // Try to parse as Date and then format to YYYY-MM-DD
                            let dateObj = new Date(tanggalLahirFormatted);
                            if (isNaN(dateObj.getTime())) {
                                // If parsing fails, try to parse as Excel serial date if it's a number string
                                const serial = parseFloat(tanggalLahirFormatted);
                                if (!isNaN(serial) && serial > 0 && serial < 60000) { // Check for a plausible serial date range
                                    dateObj = new Date(Date.UTC(1899, 11, 30)); 
                                    dateObj.setTime(dateObj.getTime() + (serial * 24 * 60 * 60 * 1000));
                                }
                            }
                            
                            if (!isNaN(dateObj.getTime())) {
                                // Simple way to get YYYY-MM-DD
                                const y = dateObj.getFullYear();
                                const m = String(dateObj.getMonth() + 1).padStart(2, '0');
                                const d = String(dateObj.getDate()).padStart(2, '0');
                                tanggalLahirFormatted = `${y}-${m}-${d}`;
                            } else {
                                tanggalLahirFormatted = ''; // Invalid date
                            }
                        }

                        const newStudent = {
                            id: generateUniqueId(),
                            namaSiswa: rowData['Nama Siswa'].trim(),
                            kelas: rowData['Kelas'].trim(),
                            nisnNis: nisnNis,
                            tempatLahir: rowData['Tempat Lahir'].trim(),
                            tanggalLahir: tanggalLahirFormatted,
                            jenisKelamin: rowData['Jenis Kelamin'].trim(),
                            agama: rowData['Agama'].trim(),
                            alamat: rowData['Alamat'].trim(),
                            namaAyah: rowData['Nama Ayah'].trim(),
                            namaIbu: rowData['Nama Ibu'].trim(),
                            pekerjaanAyah: rowData['Pekerjaan Ayah'].trim(),
                            pekerjaanIbu: rowData['Pekerjaan Ibu'].trim(),
                            pendidikanAyah: rowData['Pendidikan Ayah'].trim(),
                            pendidikanIbu: rowData['Pendidikan Ibu'].trim(),
                            noHp: rowData['No. HP'].trim(),
                            kenagarian: rowData['Kenagarian'].trim(),
                            kecamatan: rowData['Kecamatan'].trim(),
                            kabupaten: rowData['Kabupaten'].trim()
                        };
                        
                        const studentClass = newStudent.kelas.trim();

                        // Filter by currentClass for Guru roles
                        if (currentRole === 'Admin' || studentClass === currentClass) {
                            dataSiswa.push(newStudent);
                            importedCount++;
                        } else {
                            skippedCount++;
                            validationErrors.push(`Baris ${index + 2} dilewati: Siswa bukan untuk kelas Anda (${studentClass}).`);
                        }
                    });

                    saveData('dataSiswa', dataSiswa);
                    
                    let statusMessage = `Impor selesai! ${importedCount} siswa berhasil ditambahkan. ${skippedCount} siswa dilewati.`;
                    importStatusDiv.textContent = statusMessage;
                    importStatusDiv.classList.add('text-green-600');
                    showToast('Impor data berhasil!');

                    if (validationErrors.length > 0) {
                        const errorDetails = validationErrors.join('\n');
                        importStatusDiv.textContent = statusMessage + `\n\nDetail Kesalahan:\n${errorDetails}`;
                        importStatusDiv.classList.add('text-red-500');
                        importStatusDiv.classList.remove('text-green-600');
                    }

                    // Re-render relevant tables after import
                    const filteredSiswa = getFilteredSiswa();
                    renderDataSiswaTable();
                    populateSelect(ekskulSiswaSelect, filteredSiswa, 'id', 'namaSiswa');
                    populateSelect(kokurSiswaSelect, filteredSiswa, 'id', 'namaSiswa');
                    populateSelect(tpSiswaSelect, filteredSiswa, 'id', 'namaSiswa');
                    populateSelect(nilaiSiswaSelect, filteredSiswa, 'id', 'namaSiswa');
                    populateSelect(absensiSiswaSelect, filteredSiswa, 'id', 'namaSiswa');
                    populateSelect(catatanSiswaSelect, filteredSiswa, 'id', 'namaSiswa');
                    populateSelect(raporSiswaSelect, filteredSiswa, 'id', 'namaSiswa');
                    populateSelect(promoteSiswaSelect, filteredSiswa, 'id', 'namaSiswa');
                    populateSelect(identitasSiswaSelect, filteredSiswa, 'id', 'namaSiswa');

                } catch (error) {
                    showToast('Gagal membaca file Excel. Pastikan format file benar.', true);
                    importStatusDiv.textContent = `Error: ${error.message}. Pastikan file Excel valid dan tidak rusak.`;
                    importStatusDiv.classList.add('text-red-500');
                    console.error('Error processing Excel file:', error);
                }
            };
            reader.readAsText(file);
        }

        // --- Backup and Restore Data ---
        function backupData() {
            const allData = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(LS_PREFIX)) {
                    // Store only the suffix key, not the full prefix
                    allData[key.substring(LS_PREFIX.length)] = JSON.parse(localStorage.getItem(key));
                }
            }
            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `erapor_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Data berhasil di-backup!');
        }

        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            const restoredData = JSON.parse(event.target.result);
                            // Clear existing LS_PREFIX data before restoring
                            for (let i = localStorage.length - 1; i >= 0; i--) {
                                const key = localStorage.key(i);
                                if (key.startsWith(LS_PREFIX)) {
                                    localStorage.removeItem(key);
                                }
                            }
                            // Restore data with prefix
                            for (const key in restoredData) {
                                if (restoredData.hasOwnProperty(key)) {
                                    localStorage.setItem(LS_PREFIX + key, JSON.stringify(restoredData[key]));
                                }
                            }
                            loadAllData(); // Reload all data into memory
                            checkLoginStatus(); // Re-check login status as currentUser might be restored
                            showToast('Data berhasil dipulihkan!');
                        } catch (error) {
                            showToast('Gagal memulihkan data: File JSON tidak valid.', true);
                            console.error('Error restoring data:', error);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }


        // --- Pengaturan (Share Link) ---
        copyLinkBtn.addEventListener('click', function() {
            const linkInput = document.getElementById('share-link');
            // Try modern API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                 navigator.clipboard.writeText(linkInput.value).then(() => {
                    showToast('Tautan aplikasi berhasil disalin!');
                }).catch(err => {
                    console.error('Failed to copy text using clipboard API: ', err);
                    // Fallback to execCommand
                    linkInput.select();
                    document.execCommand('copy');
                    showToast('Tautan aplikasi berhasil disalin! (Fallback)');
                });
            } else {
                // Fallback to execCommand
                linkInput.select();
                document.execCommand('copy');
                showToast('Tautan aplikasi berhasil disalin!');
            }
        });

        // --- Event Listeners ---
        // Desktop login form
        if (loginForm) {
            loginForm.addEventListener('submit', (e) => handleLogin(e, false));
        }
        // Mobile login form
        if (loginFormMobile) {
            loginFormMobile.addEventListener('submit', (e) => handleLogin(e, true));
        }
        
        // Use the new header-based logout button
        if(logoutBtn) { 
            logoutBtn.addEventListener('click', handleLogout); 
        }
        
        // Link desktop and mobile backup/restore buttons to the same functions
        if (backupDataBtn) backupDataBtn.addEventListener('click', backupData);
        if (restoreDataBtn) restoreDataBtn.addEventListener('click', restoreData);
        if (backupDataBtnMobile) backupDataBtnMobile.addEventListener('click', backupData);
        if (restoreDataBtnMobile) restoreDataBtnMobile.addEventListener('click', restoreData);


        sidebarItems.forEach(item => {
            item.addEventListener('click', function() {
                const targetId = this.dataset.target;
                if (!targetId) return;

                // Authorization Check
                if (['manajemen-pengguna', 'pengaturan'].includes(targetId) && currentRole !== 'Admin') {
                    showToast('Anda tidak memiliki akses ke fitur ini.', true);
                    return;
                }
                if (targetId === 'import-data-siswa' && !(currentRole === 'Admin' || currentRole.startsWith('Guru Kelas'))) {
                    showToast('Anda tidak memiliki akses untuk mengimpor data siswa.', true);
                    return;
                }
                
                // Only Guru with assigned class can access class-specific data
                const classSpecificSections = [
                    'data-siswa', 'import-data-siswa', 'ekstrakurikuler', 'kokurikuler', 
                    'tujuan-pembelajaran', 'input-nilai', 'ketidakhadiran', 'catatan-walas', 
                    'kenaikan-kelas', 'cetak-leger', 'cetak-rapor', 'cetak-identitas-siswa'
                ];
                if (classSpecificSections.includes(targetId) && currentRole.startsWith('Guru Kelas') && !currentClass) {
                    showToast('Anda belum memiliki kelas yang terdaftar. Harap hubungi Admin.', true);
                    return;
                }
                
                activateSection(targetId);
            });
        });
        
        // Handle mobile view: hide sidebar if content is clicked
        contentSections.forEach(section => {
            section.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    // Optionally hide mobile menu if needed, but the fixed bottom bar is usually fine.
                }
            });
        });

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            loadAllData();
            checkLoginStatus();
        });
    </script>
</body>

</html>
